<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tan Pham - Tax Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --light-blue: #dbeafe;
            --success-green: #10b981;
            --danger-red: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        .app-container {
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.6s ease-out;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1 {
            font-family: 'DM Sans', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-blue);
            letter-spacing: -0.5px;
        }
        
        .tagline {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
            animation: fadeIn 0.8s ease-out 0.2s both;
            background: white;
            padding: 0;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .nav-tab {
            background: transparent;
            border: none;
            padding: 16px 24px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            position: relative;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab:first-child {
            border-radius: 10px 0 0 0;
        }
        
        .nav-tab:hover {
            color: var(--primary-blue);
            background: var(--gray-50);
        }
        
        .nav-tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background: white;
        }
        
        .section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section h2 {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.75rem;
            margin-bottom: 20px;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        
        .section h3 {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.25rem;
            margin: 25px 0 15px 0;
            color: var(--gray-800);
            font-weight: 600;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-size: 0.875rem;
            color: var(--gray-700);
            font-weight: 600;
        }
        
        input, select, textarea {
            background: white;
            border: 1.5px solid var(--gray-300);
            padding: 10px 14px;
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        button {
            background: var(--primary-blue);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: #1e40af;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: var(--gray-600);
        }
        
        button.secondary:hover {
            background: var(--gray-700);
        }
        
        button.danger {
            background: var(--danger-red);
        }
        
        button.danger:hover {
            background: #dc2626;
        }
        
        button.success {
            background: var(--success-green);
        }
        
        button.success:hover {
            background: #059669;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table thead th {
            background: var(--gray-50);
            padding: 12px 16px;
            text-align: left;
            font-size: 0.875rem;
            color: var(--gray-700);
            font-weight: 600;
            border-bottom: 2px solid var(--gray-200);
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }
        
        .data-table tbody tr:hover {
            background: var(--gray-50);
        }
        
        .data-table tbody td {
            padding: 14px 16px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-buttons button {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 10px;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            color: var(--gray-900);
        }
        
        .positive {
            color: var(--success-green);
        }
        
        .negative {
            color: var(--danger-red);
        }
        
        .tax-report {
            background: var(--gray-50);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid var(--gray-200);
            margin-top: 30px;
        }
        
        .tax-report h3 {
            color: var(--primary-blue);
            font-size: 1.75rem;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .tax-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-blue);
        }
        
        .tax-line {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .tax-line:last-child {
            border-bottom: none;
        }
        
        .tax-line.total {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary-blue);
            border-top: 2px solid var(--primary-blue);
            margin-top: 10px;
            padding-top: 15px;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .receipt-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .receipt-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        .receipt-body {
            margin: 20px 0;
        }
        
        .receipt-line {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .receipt-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--gray-200);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 0.85rem;
            }
            
            .data-table thead th,
            .data-table tbody td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Initialize SQL.js
        let db = null;
        let SQL = null; // Make SQL globally accessible
        
        const initDatabase = async () => {
            SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
            
            // Try to load existing database from localStorage
            const savedDb = localStorage.getItem('taxTrackerDb');
            if (savedDb) {
                try {
                    const uint8Array = new Uint8Array(JSON.parse(savedDb));
                    db = new SQL.Database(uint8Array);
                    
                    // Verify the schema is correct
                    const schemaCheck = db.exec("PRAGMA table_info(rental_properties)");
                    if (schemaCheck.length > 0) {
                        const columns = schemaCheck[0].values.map(row => row[1]);
                        
                        // If old schema detected, clear and start fresh
                        if (columns.includes('purchase_date') || columns.includes('purchase_price') || !columns.includes('monthly_rent')) {
                            console.log('Old database schema detected. Migrating to new schema...');
                            
                            // Ask user if they want to migrate or start fresh
                            const migrate = confirm('Old database format detected. Click OK to start fresh (recommended), or Cancel to attempt migration.');
                            
                            if (!migrate) {
                                // Start fresh
                                localStorage.removeItem('taxTrackerDb');
                                db = new SQL.Database();
                                createTables();
                            } else {
                                // Attempt migration
                                try {
                                    db.run('DROP TABLE IF EXISTS rental_properties');
                                    db.run('DROP TABLE IF EXISTS rental_income');
                                    db.run('DROP TABLE IF EXISTS rental_expenses');
                                    createTables();
                                } catch (migrationError) {
                                    console.error('Migration failed:', migrationError);
                                    alert('Migration failed. Starting with a fresh database.');
                                    localStorage.removeItem('taxTrackerDb');
                                    db = new SQL.Database();
                                    createTables();
                                }
                            }
                        }
                    }
                    
                    // Check if personal_details table exists, if not create it
                    try {
                        const personalDetailsCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='personal_details'");
                        if (personalDetailsCheck.length === 0 || personalDetailsCheck[0].values.length === 0) {
                            console.log('personal_details table not found, creating...');
                            db.run(`
                                CREATE TABLE IF NOT EXISTS personal_details (
                                    id INTEGER PRIMARY KEY,
                                    full_name TEXT DEFAULT '',
                                    abn TEXT DEFAULT '',
                                    tfn TEXT DEFAULT '',
                                    email TEXT DEFAULT '',
                                    phone TEXT DEFAULT '',
                                    address TEXT DEFAULT ''
                                )
                            `);
                            db.run(`INSERT OR IGNORE INTO personal_details (id, full_name, abn, tfn, email, phone, address) VALUES (1, '', '', '', '', '', '')`);
                            saveDatabase();
                            console.log('personal_details table created successfully');
                        }
                    } catch (tableCheckError) {
                        console.error('Error checking/creating personal_details table:', tableCheckError);
                    }
                    
                    // Check if locum_expenses table exists
                    try {
                        const locumExpensesCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='locum_expenses'");
                        if (locumExpensesCheck.length === 0 || locumExpensesCheck[0].values.length === 0) {
                            console.log('locum_expenses table not found, creating...');
                            db.run(`
                                CREATE TABLE IF NOT EXISTS locum_expenses (
                                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                                    date TEXT NOT NULL,
                                    category TEXT NOT NULL,
                                    amount REAL NOT NULL,
                                    description TEXT,
                                    deductible INTEGER DEFAULT 1,
                                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                                )
                            `);
                            saveDatabase();
                            console.log('locum_expenses table created successfully');
                        }
                    } catch (tableCheckError) {
                        console.error('Error checking/creating locum_expenses table:', tableCheckError);
                    }
                    
                    // Check if wages table exists
                    try {
                        const wagesCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='wages'");
                        if (wagesCheck.length === 0 || wagesCheck[0].values.length === 0) {
                            console.log('wages table not found, creating...');
                            db.run(`
                                CREATE TABLE IF NOT EXISTS wages (
                                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                                    pharmacy_name TEXT NOT NULL,
                                    weekly_pretax REAL NOT NULL,
                                    weekly_tax REAL DEFAULT 0,
                                    weekly_net REAL DEFAULT 0,
                                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                                )
                            `);
                            saveDatabase();
                            console.log('wages table created successfully');
                        }
                    } catch (tableCheckError) {
                        console.error('Error checking/creating wages table:', tableCheckError);
                    }
                    
                    // Check if actual_wages table exists
                    try {
                        const actualWagesCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='actual_wages'");
                        if (actualWagesCheck.length === 0 || actualWagesCheck[0].values.length === 0) {
                            console.log('actual_wages table not found, creating...');
                            db.run(`
                                CREATE TABLE IF NOT EXISTS actual_wages (
                                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                                    financial_year TEXT NOT NULL,
                                    pharmacy_name TEXT NOT NULL,
                                    actual_pretax REAL NOT NULL,
                                    actual_tax REAL NOT NULL,
                                    actual_net REAL NOT NULL,
                                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                                )
                            `);
                            saveDatabase();
                            console.log('actual_wages table created successfully');
                        }
                    } catch (tableCheckError) {
                        console.error('Error checking/creating actual_wages table:', tableCheckError);
                    }
                    
                    // Check if self_super_contributions table exists
                    try {
                        const superCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='self_super_contributions'");
                        if (superCheck.length === 0 || superCheck[0].values.length === 0) {
                            console.log('self_super_contributions table not found, creating...');
                            db.run(`
                                CREATE TABLE IF NOT EXISTS self_super_contributions (
                                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                                    financial_year TEXT NOT NULL,
                                    date TEXT NOT NULL,
                                    amount REAL NOT NULL,
                                    description TEXT,
                                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                                )
                            `);
                            saveDatabase();
                            console.log('self_super_contributions table created successfully');
                        }
                    } catch (tableCheckError) {
                        console.error('Error checking/creating self_super_contributions table:', tableCheckError);
                    }
                    
                    // Check if super_guarantee_rates table exists
                    try {
                        const sgRatesCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='super_guarantee_rates'");
                        if (sgRatesCheck.length === 0 || sgRatesCheck[0].values.length === 0) {
                            console.log('super_guarantee_rates table not found, creating...');
                            db.run(`
                                CREATE TABLE IF NOT EXISTS super_guarantee_rates (
                                    financial_year TEXT PRIMARY KEY,
                                    sg_rate REAL NOT NULL,
                                    concessional_cap REAL NOT NULL
                                )
                            `);
                            // Initialize with historical rates
                            db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2025', 0.115, 30000)");
                            db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2024', 0.115, 30000)");
                            db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2023', 0.11, 27500)");
                            db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2022', 0.105, 27500)");
                            db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2021', 0.10, 25000)");
                            db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2020', 0.095, 25000)");
                            saveDatabase();
                            console.log('super_guarantee_rates table created with historical data');
                        }
                    } catch (tableCheckError) {
                        console.error('Error checking/creating super_guarantee_rates table:', tableCheckError);
                    }
                } catch (error) {
                    console.error('Error loading database:', error);
                    alert('Error loading existing database. Starting fresh.');
                    db = new SQL.Database();
                    createTables();
                }
            } else {
                db = new SQL.Database();
                createTables();
            }
        };
        
        const createTables = () => {
            // Rental Properties Table
            db.run(`
                CREATE TABLE IF NOT EXISTS rental_properties (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    property_name TEXT NOT NULL,
                    address TEXT NOT NULL,
                    monthly_rent REAL NOT NULL DEFAULT 0,
                    contract_start TEXT,
                    contract_end TEXT,
                    tenant_name TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            db.run(`
                CREATE TABLE IF NOT EXISTS rental_income (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    property_id INTEGER,
                    date TEXT NOT NULL,
                    amount REAL NOT NULL,
                    description TEXT,
                    rental_period TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (property_id) REFERENCES rental_properties(id)
                )
            `);
            
            // Rental Expenses Table
            db.run(`
                CREATE TABLE IF NOT EXISTS rental_expenses (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    property_id INTEGER,
                    date TEXT NOT NULL,
                    category TEXT NOT NULL,
                    amount REAL NOT NULL,
                    description TEXT,
                    deductible BOOLEAN DEFAULT 1,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (property_id) REFERENCES rental_properties(id)
                )
            `);
            
            // Shares Trading Table - Clean recreation
            db.run('DROP TABLE IF EXISTS shares_positions');
            db.run('DROP TABLE IF EXISTS shares_trades');
            
            db.run(`
                CREATE TABLE shares_trades (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    date TEXT NOT NULL,
                    ticker TEXT NOT NULL,
                    transaction_type TEXT NOT NULL,
                    quantity REAL NOT NULL,
                    price REAL NOT NULL,
                    fees REAL DEFAULT 0,
                    notes TEXT,
                    company_name TEXT,
                    security_type TEXT,
                    confirmation_no TEXT,
                    order_no TEXT,
                    settlement_date TEXT,
                    consideration REAL,
                    total_cost REAL,
                    total_gst REAL,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Options Trading Table
            db.run(`
                CREATE TABLE IF NOT EXISTS options_trades (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    date TEXT NOT NULL,
                    ticker TEXT NOT NULL,
                    option_type TEXT NOT NULL,
                    strike_price REAL NOT NULL,
                    expiry_date TEXT NOT NULL,
                    transaction_type TEXT NOT NULL,
                    contracts INTEGER NOT NULL,
                    premium REAL NOT NULL,
                    fees REAL DEFAULT 0,
                    notes TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Pharmacies Table
            db.run(`
                CREATE TABLE IF NOT EXISTS pharmacies (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    address TEXT,
                    abn TEXT,
                    contact_person TEXT,
                    email TEXT,
                    phone TEXT,
                    weekday_rate REAL NOT NULL DEFAULT 0,
                    weekend_rate REAL NOT NULL DEFAULT 0,
                    public_holiday_rate REAL NOT NULL DEFAULT 0,
                    super_rate REAL NOT NULL DEFAULT 11,
                    apply_super INTEGER DEFAULT 1,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Invoices Table
            db.run(`
                CREATE TABLE IF NOT EXISTS invoices (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    pharmacy_id INTEGER,
                    invoice_number TEXT NOT NULL,
                    invoice_date TEXT NOT NULL,
                    total_amount REAL NOT NULL,
                    super_amount REAL DEFAULT 0,
                    status TEXT DEFAULT 'DRAFT',
                    notes TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (pharmacy_id) REFERENCES pharmacies(id)
                )
            `);
            
            // Invoice Line Items Table
            db.run(`
                CREATE TABLE IF NOT EXISTS invoice_items (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    invoice_id INTEGER,
                    work_date TEXT NOT NULL,
                    start_time TEXT NOT NULL,
                    end_time TEXT NOT NULL,
                    hours REAL NOT NULL,
                    rate REAL NOT NULL,
                    rate_type TEXT NOT NULL,
                    amount REAL NOT NULL,
                    FOREIGN KEY (invoice_id) REFERENCES invoices(id)
                )
            `);
            
            // Locum Expenses Table
            db.run(`
                CREATE TABLE IF NOT EXISTS locum_expenses (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    date TEXT NOT NULL,
                    category TEXT NOT NULL,
                    amount REAL NOT NULL,
                    description TEXT,
                    deductible INTEGER DEFAULT 1,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Wages Table (weekly predicted)
            db.run(`
                CREATE TABLE IF NOT EXISTS wages (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    pharmacy_name TEXT NOT NULL,
                    weekly_pretax REAL NOT NULL,
                    weekly_tax REAL DEFAULT 0,
                    weekly_net REAL DEFAULT 0,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Actual Wages Table (end of year actual)
            db.run(`
                CREATE TABLE IF NOT EXISTS actual_wages (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    financial_year TEXT NOT NULL,
                    pharmacy_name TEXT NOT NULL,
                    actual_pretax REAL NOT NULL,
                    actual_tax REAL NOT NULL,
                    actual_net REAL NOT NULL,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Self Super Contributions Table
            db.run(`
                CREATE TABLE IF NOT EXISTS self_super_contributions (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    financial_year TEXT NOT NULL,
                    date TEXT NOT NULL,
                    amount REAL NOT NULL,
                    description TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            `);
            
            // Super Guarantee Rates Table (historical rates)
            db.run(`
                CREATE TABLE IF NOT EXISTS super_guarantee_rates (
                    financial_year TEXT PRIMARY KEY,
                    sg_rate REAL NOT NULL,
                    concessional_cap REAL NOT NULL
                )
            `);
            
            // Initialize historical SG rates if table is empty
            const sgCheck = db.exec("SELECT COUNT(*) as count FROM super_guarantee_rates");
            if (sgCheck.length === 0 || sgCheck[0].values[0][0] === 0) {
                // Historical Australian SG rates
                db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2025', 0.115, 30000)");
                db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2024', 0.115, 30000)");
                db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2023', 0.11, 27500)");
                db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2022', 0.105, 27500)");
                db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2021', 0.10, 25000)");
                db.run("INSERT INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES ('2020', 0.095, 25000)");
                saveDatabase();
            }
            
            // Personal Details Table
            db.run(`
                CREATE TABLE IF NOT EXISTS personal_details (
                    id INTEGER PRIMARY KEY,
                    full_name TEXT DEFAULT '',
                    abn TEXT DEFAULT '',
                    tfn TEXT DEFAULT '',
                    email TEXT DEFAULT '',
                    phone TEXT DEFAULT '',
                    address TEXT DEFAULT ''
                )
            `);
            
            // Insert default row if not exists
            try {
                db.run(`INSERT OR IGNORE INTO personal_details (id, full_name, abn, tfn, email, phone, address) VALUES (1, '', '', '', '', '', '')`);
            } catch (e) {
                console.log('Personal details row may already exist:', e);
            }
            
            saveDatabase();
        };
        
        const saveDatabase = () => {
            const data = db.export();
            const buffer = Array.from(data);
            localStorage.setItem('taxTrackerDb', JSON.stringify(buffer));
            
            // Automatic backup - keep last 5 backups with timestamps
            const timestamp = new Date().toISOString();
            const backupKey = `taxTrackerBackup_${timestamp}`;
            localStorage.setItem(backupKey, JSON.stringify(buffer));
            
            // Clean up old backups - keep only the 5 most recent
            const allKeys = Object.keys(localStorage);
            const backupKeys = allKeys.filter(key => key.startsWith('taxTrackerBackup_')).sort().reverse();
            if (backupKeys.length > 5) {
                backupKeys.slice(5).forEach(key => localStorage.removeItem(key));
            }
        };
        
        // Expose clear database function globally for debugging
        window.clearDatabase = () => {
            if (confirm('Are you sure you want to clear all data? This cannot be undone!')) {
                localStorage.removeItem('taxTrackerDb');
                alert('Database cleared! Please refresh the page.');
                location.reload();
            }
        };
        
        // Date formatting helpers
        const formatDateForDisplay = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        };
        
        const formatCurrency = (amount) => {
            if (amount === null || amount === undefined) return '$0.00';
            return '$' + parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };
        
        const formatDateForInput = (dateStr) => {
            if (!dateStr) return '';
            // If already in YYYY-MM-DD format, return as is
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) return dateStr;
            // Otherwise convert from display format
            const parts = dateStr.match(/^(\d{2}) (\w+) (\d{4})$/);
            if (!parts) return dateStr;
            const day = parts[1];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const month = (months.indexOf(parts[2]) + 1).toString().padStart(2, '0');
            const year = parts[3];
            return `${year}-${month}-${day}`;
        };
        
        const App = () => {
            const [activeTab, setActiveTab] = useState('rental');
            const [loading, setLoading] = useState(true);
            const [properties, setProperties] = useState([]);
            const [rentalIncome, setRentalIncome] = useState([]);
            const [rentalExpenses, setRentalExpenses] = useState([]);
            const [sharesTrades, setSharesTrades] = useState([]);
            const [optionsTrades, setOptionsTrades] = useState([]);
            const [pharmacies, setPharmacies] = useState([]);
            const [invoices, setInvoices] = useState([]);
            const [professionalExpenses, setProfessionalExpenses] = useState([]);
            const [wages, setWages] = useState([]);
            const [actualWages, setActualWages] = useState([]);
            const [selfSuperContributions, setSelfSuperContributions] = useState([]);
            const [locumExpenses, setLocumExpenses] = useState([]);
            const [personalDetails, setPersonalDetails] = useState({
                full_name: '',
                abn: '',
                tfn: '',
                email: '',
                phone: '',
                address: ''
            });
            
            useEffect(() => {
                initDatabase().then(() => {
                    try {
                        loadAllData();
                        setLoading(false);
                    } catch (error) {
                        console.error('Error loading data:', error);
                        setLoading(false);
                    }
                }).catch(error => {
                    console.error('Error initializing database:', error);
                    setLoading(false);
                });
            }, []);
            
            const loadAllData = () => {
                loadProperties();
                loadRentalIncome();
                loadRentalExpenses();
                loadSharesTrades();
                loadOptionsTrades();
                loadPharmacies();
                loadInvoices();
                loadPersonalDetails();
                loadLocumExpenses();
                loadWages();
                loadActualWages();
                loadSelfSuperContributions();
            };
            
            const loadProperties = () => {
                const result = db.exec('SELECT * FROM rental_properties ORDER BY id DESC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        property_name: row[1],
                        address: row[2],
                        monthly_rent: row[3],
                        contract_start: row[4],
                        contract_end: row[5],
                        tenant_name: row[6],
                        created_at: row[7]
                    }));
                    setProperties(data);
                } else {
                    setProperties([]);
                }
            };
            
            const loadRentalIncome = () => {
                const result = db.exec(`
                    SELECT ri.*, rp.property_name 
                    FROM rental_income ri 
                    LEFT JOIN rental_properties rp ON ri.property_id = rp.id 
                    ORDER BY ri.date DESC
                `);
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        property_id: row[1],
                        date: row[2],
                        amount: row[3],
                        description: row[4],
                        rental_period: row[5],
                        created_at: row[6],
                        property_name: row[7]
                    }));
                    setRentalIncome(data);
                } else {
                    setRentalIncome([]);
                }
            };
            
            const loadRentalExpenses = () => {
                const result = db.exec(`
                    SELECT re.*, rp.property_name 
                    FROM rental_expenses re 
                    LEFT JOIN rental_properties rp ON re.property_id = rp.id 
                    ORDER BY re.date DESC
                `);
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        property_id: row[1],
                        date: row[2],
                        category: row[3],
                        amount: row[4],
                        description: row[5],
                        deductible: row[6],
                        created_at: row[7],
                        property_name: row[8]
                    }));
                    setRentalExpenses(data);
                } else {
                    setRentalExpenses([]);
                }
            };
            
            const loadSharesTrades = () => {
                const result = db.exec('SELECT * FROM shares_trades ORDER BY date DESC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        date: row[1],
                        ticker: row[2],
                        transaction_type: row[3],
                        quantity: row[4],
                        price: row[5],
                        fees: row[6],
                        notes: row[7],
                        created_at: row[8]
                    }));
                    setSharesTrades(data);
                } else {
                    setSharesTrades([]);
                }
            };
            
            const loadOptionsTrades = () => {
                const result = db.exec('SELECT * FROM options_trades ORDER BY date DESC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        date: row[1],
                        ticker: row[2],
                        option_type: row[3],
                        strike_price: row[4],
                        expiry_date: row[5],
                        transaction_type: row[6],
                        contracts: row[7],
                        premium: row[8],
                        fees: row[9],
                        notes: row[10],
                        created_at: row[11]
                    }));
                    setOptionsTrades(data);
                } else {
                    setOptionsTrades([]);
                }
            };
            
            const loadPharmacies = () => {
                const result = db.exec('SELECT * FROM pharmacies ORDER BY name ASC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        name: row[1],
                        address: row[2],
                        abn: row[3],
                        contact_person: row[4],
                        email: row[5],
                        phone: row[6],
                        weekday_rate: row[7],
                        weekend_rate: row[8],
                        public_holiday_rate: row[9],
                        super_rate: row[10],
                        apply_super: row[11],
                        created_at: row[12]
                    }));
                    setPharmacies(data);
                } else {
                    setPharmacies([]);
                }
            };
            
            const loadInvoices = () => {
                const result = db.exec(`
                    SELECT i.*, p.name as pharmacy_name 
                    FROM invoices i 
                    LEFT JOIN pharmacies p ON i.pharmacy_id = p.id 
                    ORDER BY i.invoice_date DESC
                `);
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        pharmacy_id: row[1],
                        invoice_number: row[2],
                        invoice_date: row[3],
                        total_amount: row[4],
                        super_amount: row[5],
                        status: row[6],
                        notes: row[7],
                        created_at: row[8],
                        pharmacy_name: row[9]
                    }));
                    setInvoices(data);
                } else {
                    setInvoices([]);
                }
            };
            
            const loadPersonalDetails = () => {
                try {
                    const result = db.exec('SELECT * FROM personal_details WHERE id = 1');
                    if (result.length > 0 && result[0].values.length > 0) {
                        const row = result[0].values[0];
                        setPersonalDetails({
                            full_name: row[1] || '',
                            abn: row[2] || '',
                            tfn: row[3] || '',
                            email: row[4] || '',
                            phone: row[5] || '',
                            address: row[6] || ''
                        });
                    } else {
                        // No data found, ensure row exists
                        db.run(`INSERT OR IGNORE INTO personal_details (id, full_name, abn, tfn, email, phone, address) VALUES (1, '', '', '', '', '', '')`);
                        saveDatabase();
                    }
                } catch (error) {
                    console.error('Error loading personal details:', error);
                }
            };
            
            const loadLocumExpenses = () => {
                const result = db.exec('SELECT * FROM locum_expenses ORDER BY date DESC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        date: row[1],
                        category: row[2],
                        amount: row[3],
                        description: row[4],
                        deductible: row[5],
                        created_at: row[6]
                    }));
                    setProfessionalExpenses(data);
                } else {
                    setProfessionalExpenses([]);
                }
            };
            
            const loadWages = () => {
                const result = db.exec('SELECT * FROM wages ORDER BY id DESC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        pharmacy_name: row[1],
                        weekly_pretax: row[2],
                        weekly_tax: row[3],
                        weekly_net: row[4],
                        created_at: row[5]
                    }));
                    setWages(data);
                } else {
                    setWages([]);
                }
            };
            
            const loadActualWages = () => {
                const result = db.exec('SELECT * FROM actual_wages ORDER BY financial_year DESC, id DESC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        financial_year: row[1],
                        pharmacy_name: row[2],
                        actual_pretax: row[3],
                        actual_tax: row[4],
                        actual_net: row[5],
                        created_at: row[6]
                    }));
                    setActualWages(data);
                } else {
                    setActualWages([]);
                }
            };
            
            const loadSelfSuperContributions = () => {
                const result = db.exec('SELECT * FROM self_super_contributions ORDER BY financial_year DESC, date DESC');
                if (result.length > 0) {
                    const data = result[0].values.map(row => ({
                        id: row[0],
                        financial_year: row[1],
                        date: row[2],
                        amount: row[3],
                        description: row[4],
                        created_at: row[5]
                    }));
                    setSelfSuperContributions(data);
                } else {
                    setSelfSuperContributions([]);
                }
            };
            
            if (loading) {
                return <div className="app-container"><div className="loading">Initializing Database...</div></div>;
            }
            
            return (
                <div className="app-container">
                    <header>
                        <h1>Tan Pham</h1>
                        <p className="tagline">Incomes and expenses</p>
                        <div style={{position: 'absolute', top: '20px', right: '20px', display: 'flex', gap: '10px'}}>
                            <button 
                                onClick={() => {
                                    // Manual backup download
                                    const data = db.export();
                                    const buffer = Array.from(data);
                                    const jsonStr = JSON.stringify(buffer);
                                    const blob = new Blob([jsonStr], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                                    a.download = `tax-tracker-backup-${timestamp}.json`;
                                    a.click();
                                    URL.revokeObjectURL(url);
                                }}
                                style={{
                                    padding: '10px 20px',
                                    background: '#10b981',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '0.9rem',
                                    fontWeight: '600'
                                }}
                            >
                                 Download Backup
                            </button>
                            <button 
                                onClick={() => {
                                    const input = document.createElement('input');
                                    input.type = 'file';
                                    input.accept = '.json';
                                    input.onchange = (e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onload = (event) => {
                                                try {
                                                    const buffer = JSON.parse(event.target.result);
                                                    const uint8Array = new Uint8Array(buffer);
                                                    db = new SQL.Database(uint8Array);
                                                    saveDatabase();
                                                    alert(' Database restored successfully!');
                                                    window.location.reload();
                                                } catch (error) {
                                                    alert(' Error restoring backup: ' + error.message);
                                                }
                                            };
                                            reader.readAsText(file);
                                        }
                                    };
                                    input.click();
                                }}
                                style={{
                                    padding: '10px 20px',
                                    background: '#f59e0b',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '0.9rem',
                                    fontWeight: '600'
                                }}
                            >
                                 Restore Backup
                            </button>
                            <button 
                                onClick={() => {
                                    if (confirm(' Reset Database?\n\nThis will DELETE ALL DATA and create fresh tables.\n\nUse this if you see "no such table" errors.\n\nContinue?')) {
                                        localStorage.clear();
                                        window.location.reload();
                                    }
                                }}
                                style={{
                                    padding: '10px 20px',
                                    background: '#d9534f',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    fontSize: '0.9rem',
                                    fontWeight: '600'
                                }}
                            >
                                 Reset Database
                            </button>
                        </div>
                    </header>
                    
                    <nav className="nav-tabs">
                        <button 
                            className={`nav-tab ${activeTab === 'rental' ? 'active' : ''}`}
                            onClick={() => setActiveTab('rental')}
                        >
                            Rental Properties
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'locum' ? 'active' : ''}`}
                            onClick={() => setActiveTab('locum')}
                        >
                            Locum Pharmacist
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'wages' ? 'active' : ''}`}
                            onClick={() => setActiveTab('wages')}
                        >
                            Part-Time Wages
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'super' ? 'active' : ''}`}
                            onClick={() => setActiveTab('super')}
                        >
                            Superannuation
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'shares' ? 'active' : ''}`}
                            onClick={() => setActiveTab('shares')}
                        >
                            Shares Trading
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'options' ? 'active' : ''}`}
                            onClick={() => setActiveTab('options')}
                        >
                            Options Trading
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'personal' ? 'active' : ''}`}
                            onClick={() => setActiveTab('personal')}
                        >
                            Personal Details
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'expenses' ? 'active' : ''}`}
                            onClick={() => setActiveTab('expenses')}
                        >
                            Professional Expenses
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'tax' ? 'active' : ''}`}
                            onClick={() => setActiveTab('tax')}
                        >
                            Tax Report
                        </button>
                    </nav>
                    
                    {activeTab === 'rental' && (
                        <RentalSection 
                            properties={properties}
                            income={rentalIncome}
                            expenses={rentalExpenses}
                            onUpdate={loadAllData}
                        />
                    )}
                    
                    {activeTab === 'locum' && (
                        <LocumSection 
                            pharmacies={pharmacies}
                            invoices={invoices}
                            locumExpenses={locumExpenses}
                            onUpdate={loadAllData}
                            personalDetails={personalDetails}
                        />
                    )}
                    
                    {activeTab === 'wages' && (
                        <WagesSection 
                            wages={wages}
                            actualWages={actualWages}
                            onUpdate={loadAllData}
                        />
                    )}
                    
                    {activeTab === 'super' && (
                        <SuperannuationSection 
                            wages={wages}
                            actualWages={actualWages}
                            invoices={invoices}
                            selfSuperContributions={selfSuperContributions}
                            onUpdate={loadAllData}
                        />
                    )}
                    
                    {activeTab === 'shares' && (
                        <SharesSection 
                            trades={sharesTrades}
                            onUpdate={loadSharesTrades}
                        />
                    )}
                    
                    {activeTab === 'options' && (
                        <OptionsSection 
                            trades={optionsTrades}
                            onUpdate={loadOptionsTrades}
                        />
                    )}
                    
                    {activeTab === 'personal' && (
                        <div className="section">
                            <h2> Personal Details</h2>
                            <p style={{color: 'var(--text-secondary)', marginBottom: '30px'}}>
                                Enter your details to include in receipts and tax reports
                            </p>
                            
                            <div className="form-grid" style={{maxWidth: '600px'}}>
                                <div className="form-group">
                                    <label>Full Name</label>
                                    <input 
                                        type="text" 
                                        value={personalDetails.full_name}
                                        onChange={(e) => setPersonalDetails({...personalDetails, full_name: e.target.value})}
                                        placeholder="Tan Pham"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>ABN (Australian Business Number)</label>
                                    <input 
                                        type="text" 
                                        value={personalDetails.abn}
                                        onChange={(e) => setPersonalDetails({...personalDetails, abn: e.target.value})}
                                        placeholder="12 345 678 901"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>TFN (Tax File Number)</label>
                                    <input 
                                        type="text" 
                                        value={personalDetails.tfn}
                                        onChange={(e) => setPersonalDetails({...personalDetails, tfn: e.target.value})}
                                        placeholder="123 456 789"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Email</label>
                                    <input 
                                        type="email" 
                                        value={personalDetails.email}
                                        onChange={(e) => setPersonalDetails({...personalDetails, email: e.target.value})}
                                        placeholder="tan@example.com"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Phone</label>
                                    <input 
                                        type="text" 
                                        value={personalDetails.phone}
                                        onChange={(e) => setPersonalDetails({...personalDetails, phone: e.target.value})}
                                        placeholder="0412 345 678"
                                    />
                                </div>
                                <div className="form-group" style={{gridColumn: '1 / -1'}}>
                                    <label>Address</label>
                                    <input 
                                        type="text" 
                                        value={personalDetails.address}
                                        onChange={(e) => setPersonalDetails({...personalDetails, address: e.target.value})}
                                        placeholder="123 Main St, Sydney NSW 2000"
                                    />
                                </div>
                                <div className="form-group">
                                    <button onClick={() => {
                                        try {
                                            db.run(
                                                'UPDATE personal_details SET full_name = ?, abn = ?, tfn = ?, email = ?, phone = ?, address = ? WHERE id = 1',
                                                [personalDetails.full_name, personalDetails.abn, personalDetails.tfn, personalDetails.email, personalDetails.phone, personalDetails.address]
                                            );
                                            saveDatabase();
                                            loadPersonalDetails();
                                            alert(' Personal details saved successfully!');
                                        } catch (error) {
                                            console.error('Error saving personal details:', error);
                                            alert(' Error saving details: ' + error.message);
                                        }
                                    }}>
                                        Save Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {activeTab === 'expenses' && (
                        <ProfessionalExpensesSection 
                            expenses={professionalExpenses}
                            onUpdate={loadAllData}
                        />
                    )}
                    
                    {activeTab === 'tax' && (
                        <TaxReportSection 
                            properties={properties}
                            rentalIncome={rentalIncome}
                            rentalExpenses={rentalExpenses}
                            sharesTrades={sharesTrades}
                            optionsTrades={optionsTrades}
                            invoices={invoices}
                            personalDetails={personalDetails}
                            professionalExpenses={professionalExpenses}
                            wages={wages}
                            actualWages={actualWages}
                            selfSuperContributions={selfSuperContributions}
                        />
                    )}
                </div>
            );
        };
        
        const InvoiceForm = ({ pharmacies, onUpdate, onClose }) => {
            const [selectedPharmacy, setSelectedPharmacy] = React.useState('');
            const [invoiceDate, setInvoiceDate] = React.useState('');
            const [customSuperRate, setCustomSuperRate] = React.useState('12');
            const [lineItems, setLineItems] = React.useState([
                { work_date: '', start_time: '', end_time: '', rate_type: 'weekday', hours: 0, rate: 0, amount: 0 }
            ]);
            
            const pharmacy = pharmacies.find(p => p.id === parseInt(selectedPharmacy));
            
            // Auto-update rates when pharmacy is selected
            React.useEffect(() => {
                if (pharmacy) {
                    const updatedItems = lineItems.map(item => {
                        const rate = item.rate_type === 'weekday' ? pharmacy.weekday_rate :
                                    item.rate_type === 'weekend' ? pharmacy.weekend_rate : 
                                    pharmacy.public_holiday_rate;
                        return {
                            ...item,
                            rate: rate,
                            amount: item.hours * rate
                        };
                    });
                    setLineItems(updatedItems);
                }
            }, [selectedPharmacy]);
            
            const calculateHours = (start, end) => {
                if (!start || !end) return 0;
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                const startMins = startH * 60 + startM;
                const endMins = endH * 60 + endM;
                return ((endMins - startMins) / 60).toFixed(2);
            };
            
            const updateLineItem = (index, field, value) => {
                const newItems = [...lineItems];
                newItems[index][field] = value;
                
                // Calculate hours when time changes
                if (field === 'start_time' || field === 'end_time') {
                    const hours = calculateHours(newItems[index].start_time, newItems[index].end_time);
                    newItems[index].hours = parseFloat(hours);
                }
                
                // Update rate when rate type changes
                if (field === 'rate_type' && pharmacy) {
                    newItems[index].rate = value === 'weekday' ? pharmacy.weekday_rate :
                                          value === 'weekend' ? pharmacy.weekend_rate : pharmacy.public_holiday_rate;
                }
                
                // Handle manual rate changes
                if (field === 'rate') {
                    newItems[index].rate = parseFloat(value) || 0;
                }
                
                // Always recalculate amount
                newItems[index].amount = parseFloat(newItems[index].hours || 0) * parseFloat(newItems[index].rate || 0);
                setLineItems(newItems);
            };
            
            const addLineItem = () => {
                setLineItems([...lineItems, { work_date: '', start_time: '', end_time: '', rate_type: 'weekday', hours: 0, rate: 0, amount: 0 }]);
            };
            
            const removeLineItem = (index) => {
                setLineItems(lineItems.filter((_, i) => i !== index));
            };
            
            const totalAmount = lineItems.reduce((sum, item) => sum + item.amount, 0);
            const superAmount = pharmacy && pharmacy.apply_super ? totalAmount * (parseFloat(customSuperRate) / 100) : 0;
            const grandTotal = totalAmount + superAmount;
            
            const saveInvoice = () => {
                if (!selectedPharmacy || !invoiceDate || lineItems.length === 0) {
                    alert('Please fill in pharmacy, date and at least one work entry');
                    return;
                }
                
                const invoiceNumber = `INV-${Date.now()}`;
                
                db.run(
                    'INSERT INTO invoices (pharmacy_id, invoice_number, invoice_date, total_amount, super_amount, status) VALUES (?, ?, ?, ?, ?, ?)',
                    [parseInt(selectedPharmacy), invoiceNumber, invoiceDate, totalAmount, superAmount, 'ISSUED']
                );
                
                const invoiceId = db.exec('SELECT last_insert_rowid()')[0].values[0][0];
                
                lineItems.forEach(item => {
                    db.run(
                        'INSERT INTO invoice_items (invoice_id, work_date, start_time, end_time, hours, rate, rate_type, amount) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
                        [invoiceId, item.work_date, item.start_time, item.end_time, item.hours, item.rate, item.rate_type, item.amount]
                    );
                });
                
                saveDatabase();
                onUpdate();
                onClose();
            };
            
            return (
                <div style={{marginTop: '20px', padding: '20px', background: '#f9f9f9', borderRadius: '8px'}}>
                    <h3>Create Invoice</h3>
                    <div className="form-grid">
                        <div className="form-group">
                            <label>Pharmacy *</label>
                            <select value={selectedPharmacy} onChange={(e) => setSelectedPharmacy(e.target.value)}>
                                <option value="">Select Pharmacy</option>
                                {pharmacies.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Invoice Date *</label>
                            <input type="date" value={invoiceDate} onChange={(e) => setInvoiceDate(e.target.value)} />
                        </div>
                    </div>
                    
                    {pharmacy && (
                        <div style={{marginTop: '20px', padding: '15px', background: 'white', borderRadius: '6px'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '20px', flexWrap: 'wrap'}}>
                                <div>
                                    <strong>Rates:</strong> Weekday: ${pharmacy.weekday_rate}/hr | Weekend: ${pharmacy.weekend_rate}/hr | Public Holiday: ${pharmacy.public_holiday_rate}/hr
                                </div>
                                {pharmacy.apply_super && (
                                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <label style={{margin: 0, fontWeight: '600'}}>Super Rate:</label>
                                        <input 
                                            type="number" 
                                            step="0.1" 
                                            value={customSuperRate}
                                            onChange={(e) => setCustomSuperRate(e.target.value)}
                                            style={{width: '80px', padding: '6px'}}
                                        />
                                        <span>%</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <h4 style={{marginTop: '20px'}}>Work Hours</h4>
                    {lineItems.map((item, index) => (
                        <div key={index} className="form-grid" style={{marginTop: '10px', padding: '15px', background: 'white', borderRadius: '6px'}}>
                            <div className="form-group">
                                <label>Date</label>
                                <input type="date" value={item.work_date} onChange={(e) => updateLineItem(index, 'work_date', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label>Start Time</label>
                                <input type="time" value={item.start_time} onChange={(e) => updateLineItem(index, 'start_time', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label>End Time</label>
                                <input type="time" value={item.end_time} onChange={(e) => updateLineItem(index, 'end_time', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label>Rate Type</label>
                                <select value={item.rate_type} onChange={(e) => updateLineItem(index, 'rate_type', e.target.value)}>
                                    <option value="weekday">Weekday</option>
                                    <option value="weekend">Weekend</option>
                                    <option value="public_holiday">Public Holiday</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Hours</label>
                                <input type="number" value={item.hours} readOnly style={{background: '#f0f0f0'}} />
                            </div>
                            <div className="form-group">
                                <label>Rate ($/hr)</label>
                                <input 
                                    type="number" 
                                    step="0.01"
                                    value={item.rate} 
                                    onChange={(e) => updateLineItem(index, 'rate', e.target.value)}
                                    placeholder="Enter rate"
                                />
                            </div>
                            <div className="form-group">
                                <label>Amount</label>
                                <input type="number" value={item.amount.toFixed(2)} readOnly style={{background: '#f0f0f0'}} />
                            </div>
                            <div className="form-group" style={{display: 'flex', alignItems: 'flex-end'}}>
                                <button className="danger" onClick={() => removeLineItem(index)}>Remove</button>
                            </div>
                        </div>
                    ))}
                    
                    <button onClick={addLineItem} style={{marginTop: '10px'}}>+ Add Line</button>
                    
                    <div style={{marginTop: '20px', padding: '15px', background: 'white', borderRadius: '6px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                            <strong>Subtotal:</strong>
                            <span>${totalAmount.toFixed(2)}</span>
                        </div>
                        {pharmacy && pharmacy.apply_super && (
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                <strong>Superannuation ({customSuperRate}%):</strong>
                                <span>${superAmount.toFixed(2)}</span>
                            </div>
                        )}
                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '1.2em', paddingTop: '10px', borderTop: '2px solid #ddd'}}>
                            <strong>Total:</strong>
                            <strong className="positive">${grandTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    <div className="button-group" style={{marginTop: '20px'}}>
                        <button onClick={saveInvoice}>Save Invoice</button>
                        <button onClick={onClose} style={{background: '#666'}}>Cancel</button>
                    </div>
                </div>
            );
        };
        
        const InvoiceViewer = ({ invoice, onClose, personalDetails }) => {
            try {
                if (!db) {
                    return (
                        <div style={{padding: '20px', textAlign: 'center'}}>
                            <p>Database not initialized</p>
                            <button onClick={onClose}>Close</button>
                        </div>
                    );
                }
                
                const pharmacyResult = db.exec('SELECT * FROM pharmacies WHERE id = ?', [invoice.pharmacy_id]);
                if (!pharmacyResult || pharmacyResult.length === 0 || !pharmacyResult[0].values || pharmacyResult[0].values.length === 0) {
                    return (
                        <div style={{padding: '20px', textAlign: 'center'}}>
                            <p>Error: Pharmacy not found</p>
                            <button onClick={onClose}>Close</button>
                        </div>
                    );
                }
                const pharmacy = pharmacyResult[0].values[0];
                
                const items = db.exec('SELECT * FROM invoice_items WHERE invoice_id = ? ORDER BY work_date, start_time', [invoice.id]);
                
                const lineItems = items.length > 0 ? items[0].values.map(row => ({
                    work_date: row[2],
                    start_time: row[3],
                    end_time: row[4],
                    hours: row[5],
                    rate: row[6],
                    rate_type: row[7],
                    amount: row[8]
                })) : [];
            
            const printInvoice = () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(20);
                    doc.text('INVOICE', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    const providerName = (personalDetails && personalDetails.full_name) ? personalDetails.full_name : 'Tan Pham';
                    doc.text(`${providerName} - Locum Pharmacist`, 20, 40);
                    if (personalDetails && personalDetails.abn) {
                        doc.text(`ABN: ${personalDetails.abn}`, 20, 46);
                    }
                    const hasABN = personalDetails && personalDetails.abn;
                    doc.text(`Invoice #: ${invoice.invoice_number}`, 20, hasABN ? 56 : 50);
                    doc.text(`Date: ${formatDateForDisplay(invoice.invoice_date)}`, 20, hasABN ? 62 : 56);
                    
                    doc.text('Bill To:', 20, 76);
                    doc.setFontSize(12);
                    doc.text(pharmacy[1], 20, 82);
                    if (pharmacy[2]) doc.setFontSize(10), doc.text(pharmacy[2], 20, 88);
                    
                    let y = 106;
                doc.setFontSize(10);
                doc.text('Date', 20, y);
                doc.text('Time', 60, y);
                doc.text('Hours', 100, y);
                doc.text('Rate', 130, y);
                doc.text('Amount', 160, y);
                
                y += 6;
                lineItems.forEach(item => {
                    doc.text(formatDateForDisplay(item.work_date), 20, y);
                    doc.text(`${item.start_time} - ${item.end_time}`, 60, y);
                    doc.text(item.hours.toString(), 100, y);
                    doc.text(`$${item.rate.toFixed(2)}`, 130, y);
                    doc.text(`$${item.amount.toFixed(2)}`, 160, y);
                    y += 6;
                });
                
                y += 10;
                doc.text('Subtotal:', 130, y);
                doc.text(`$${invoice.total_amount.toFixed(2)}`, 160, y);
                
                if (invoice.super_amount > 0) {
                    y += 6;
                    doc.text(`Superannuation:`, 130, y);
                    doc.text(`$${invoice.super_amount.toFixed(2)}`, 160, y);
                }
                
                y += 6;
                doc.setFontSize(12);
                doc.text('TOTAL:', 130, y);
                doc.text(`$${(invoice.total_amount + invoice.super_amount).toFixed(2)}`, 160, y);
                
                doc.save(`${invoice.invoice_number}.pdf`);
                } catch (error) {
                    console.error('Error printing invoice:', error);
                    alert(' Error generating PDF: ' + error.message);
                }
            };
            
            return (
                <div style={{marginTop: '20px', padding: '20px', background: 'white', border: '1px solid #ddd', borderRadius: '8px'}}>
                    <h3>Invoice #{invoice.invoice_number}</h3>
                    <p>Date: {formatDateForDisplay(invoice.invoice_date)}</p>
                    <p>Pharmacy: <strong>{pharmacy[1]}</strong></p>
                    
                    <table className="data-table" style={{marginTop: '20px'}}>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Hours</th>
                                <th>Rate</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {lineItems.map((item, i) => (
                                <tr key={i}>
                                    <td>{formatDateForDisplay(item.work_date)}</td>
                                    <td>{item.start_time} - {item.end_time}</td>
                                    <td>{item.rate_type.replace('_', ' ')}</td>
                                    <td>{item.hours}</td>
                                    <td>${item.rate.toFixed(2)}</td>
                                    <td>${item.amount.toFixed(2)}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    
                    <div style={{marginTop: '20px', textAlign: 'right'}}>
                        <p>Subtotal: ${invoice.total_amount.toFixed(2)}</p>
                        {invoice.super_amount > 0 && <p>Superannuation: ${invoice.super_amount.toFixed(2)}</p>}
                        <p style={{fontSize: '1.2em'}}><strong>Total: ${(invoice.total_amount + invoice.super_amount).toFixed(2)}</strong></p>
                    </div>
                    
                    <div className="button-group" style={{marginTop: '20px'}}>
                        <button onClick={printInvoice}>Print PDF</button>
                        <button onClick={onClose} style={{background: '#666'}}>Close</button>
                    </div>
                </div>
            );
            } catch (error) {
                console.error('Error in InvoiceViewer:', error);
                return (
                    <div style={{padding: '20px', textAlign: 'center', color: '#d9534f'}}>
                        <h3>Error Loading Invoice</h3>
                        <p>{error.message}</p>
                        <button onClick={onClose}>Close</button>
                    </div>
                );
            }
        };
        
        const LocumSection = ({ pharmacies, invoices, locumExpenses, onUpdate, personalDetails }) => {
            const [activeSubTab, setActiveSubTab] = useState('pharmacies');
            
            return (
                <>
                    <div className="section">
                        <h2> Locum Pharmacist</h2>
                        
                        <nav className="nav-tabs" style={{marginTop: '20px'}}>
                            <button 
                                className={`nav-tab ${activeSubTab === 'pharmacies' ? 'active' : ''}`}
                                onClick={() => setActiveSubTab('pharmacies')}
                            >
                                Pharmacies
                            </button>
                            <button 
                                className={`nav-tab ${activeSubTab === 'invoices' ? 'active' : ''}`}
                                onClick={() => setActiveSubTab('invoices')}
                            >
                                Invoices
                            </button>
                        </nav>
                        
                        {activeSubTab === 'pharmacies' && (
                            <PharmaciesTab pharmacies={pharmacies} onUpdate={onUpdate} />
                        )}
                        
                        {activeSubTab === 'invoices' && (
                            <InvoicesTab pharmacies={pharmacies} invoices={invoices} onUpdate={onUpdate} personalDetails={personalDetails} />
                        )}
                    </div>
                </>
            );
        };
        
        const PharmaciesTab = ({ pharmacies, onUpdate }) => {
            const [showForm, setShowForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [form, setForm] = useState({
                name: '',
                address: '',
                abn: '',
                contact_person: '',
                email: '',
                phone: '',
                weekday_rate: '',
                weekend_rate: '',
                public_holiday_rate: '',
                super_rate: '12',
                apply_super: true
            });
            
            const startEdit = (pharmacy) => {
                setEditingId(pharmacy.id);
                setForm({
                    name: pharmacy.name,
                    address: pharmacy.address || '',
                    abn: pharmacy.abn || '',
                    contact_person: pharmacy.contact_person || '',
                    email: pharmacy.email || '',
                    phone: pharmacy.phone || '',
                    weekday_rate: pharmacy.weekday_rate.toString(),
                    weekend_rate: pharmacy.weekend_rate.toString(),
                    public_holiday_rate: pharmacy.public_holiday_rate.toString(),
                    super_rate: pharmacy.super_rate.toString(),
                    apply_super: pharmacy.apply_super === 1
                });
                setShowForm(true);
            };
            
            const cancelEdit = () => {
                setEditingId(null);
                setShowForm(false);
                setForm({
                    name: '', address: '', abn: '', contact_person: '', email: '', phone: '',
                    weekday_rate: '', weekend_rate: '', public_holiday_rate: '', super_rate: '12', apply_super: true
                });
            };
            
            const updatePharmacy = () => {
                try {
                    if (!form.name || !form.weekday_rate || !form.weekend_rate || !form.public_holiday_rate) {
                        alert('Please fill in pharmacy name and all rates');
                        return;
                    }
                    
                    db.run(
                        'UPDATE pharmacies SET name=?, address=?, abn=?, contact_person=?, email=?, phone=?, weekday_rate=?, weekend_rate=?, public_holiday_rate=?, super_rate=?, apply_super=? WHERE id=?',
                        [form.name, form.address || '', form.abn || '', form.contact_person || '', form.email || '', form.phone || '',
                         parseFloat(form.weekday_rate), parseFloat(form.weekend_rate), parseFloat(form.public_holiday_rate),
                         parseFloat(form.super_rate), form.apply_super ? 1 : 0, editingId]
                    );
                    saveDatabase();
                    cancelEdit();
                    onUpdate();
                } catch (error) {
                    console.error('Error updating pharmacy:', error);
                    alert('Error updating pharmacy: ' + error.message);
                }
            };
            
            const addPharmacy = () => {
                try {
                    // Validation
                    if (!form.name || !form.weekday_rate || !form.weekend_rate || !form.public_holiday_rate) {
                        alert('Please fill in pharmacy name and all rates');
                        return;
                    }
                    
                    db.run(
                        'INSERT INTO pharmacies (name, address, abn, contact_person, email, phone, weekday_rate, weekend_rate, public_holiday_rate, super_rate, apply_super) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)',
                        [form.name, form.address || '', form.abn || '', form.contact_person || '', form.email || '', form.phone || '',
                         parseFloat(form.weekday_rate), parseFloat(form.weekend_rate), parseFloat(form.public_holiday_rate),
                         parseFloat(form.super_rate), form.apply_super ? 1 : 0]
                    );
                    saveDatabase();
                    setForm({ name: '', address: '', abn: '', contact_person: '', email: '', phone: '',
                             weekday_rate: '', weekend_rate: '', public_holiday_rate: '', super_rate: '12', apply_super: true });
                    setShowForm(false);
                    onUpdate();
                } catch (error) {
                    console.error('Error saving pharmacy:', error);
                    alert('Error saving pharmacy: ' + error.message);
                }
            };
            
            const deletePharmacy = (id) => {
                if (confirm('Delete this pharmacy?')) {
                    db.run('DELETE FROM pharmacies WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            return (
                <>
                    <div className="button-group">
                        <button onClick={() => editingId ? cancelEdit() : setShowForm(!showForm)}>
                            {showForm ? 'Cancel' : 'Add Pharmacy'}
                        </button>
                    </div>
                    
                    {showForm && (
                        <div className="form-grid" style={{marginTop: '20px'}}>
                            <h3>{editingId ? 'Edit Pharmacy' : 'Add Pharmacy'}</h3>
                            <div className="form-group">
                                <label>Pharmacy Name *</label>
                                <input value={form.name} onChange={(e) => setForm({...form, name: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Address</label>
                                <input value={form.address} onChange={(e) => setForm({...form, address: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>ABN</label>
                                <input value={form.abn} onChange={(e) => setForm({...form, abn: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Contact Person</label>
                                <input value={form.contact_person} onChange={(e) => setForm({...form, contact_person: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Email</label>
                                <input type="email" value={form.email} onChange={(e) => setForm({...form, email: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Phone</label>
                                <input value={form.phone} onChange={(e) => setForm({...form, phone: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Weekday Rate ($/hr) *</label>
                                <input type="number" step="0.01" value={form.weekday_rate} onChange={(e) => setForm({...form, weekday_rate: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Weekend Rate ($/hr) *</label>
                                <input type="number" step="0.01" value={form.weekend_rate} onChange={(e) => setForm({...form, weekend_rate: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Public Holiday Rate ($/hr) *</label>
                                <input type="number" step="0.01" value={form.public_holiday_rate} onChange={(e) => setForm({...form, public_holiday_rate: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Superannuation Rate (%)</label>
                                <input type="number" step="0.01" value={form.super_rate} onChange={(e) => setForm({...form, super_rate: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <input 
                                        type="checkbox" 
                                        checked={form.apply_super}
                                        onChange={(e) => setForm({...form, apply_super: e.target.checked})}
                                        style={{width: 'auto'}}
                                    />
                                    Apply Superannuation
                                </label>
                            </div>
                            <div className="form-group" style={{display: 'flex', alignItems: 'flex-end', gap: '10px'}}>
                                <button onClick={editingId ? updatePharmacy : addPharmacy}>
                                    {editingId ? 'Update Pharmacy' : 'Save Pharmacy'}
                                </button>
                                {editingId && (
                                    <button onClick={cancelEdit} style={{background: '#666'}}>Cancel</button>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {pharmacies.length > 0 ? (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Contact</th>
                                    <th>Weekday</th>
                                    <th>Weekend</th>
                                    <th>Public Holiday</th>
                                    <th>Super</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {pharmacies.map(pharmacy => (
                                    <tr key={pharmacy.id}>
                                        <td><strong>{pharmacy.name}</strong></td>
                                        <td>{pharmacy.address}</td>
                                        <td>
                                            {pharmacy.contact_person && <div>{pharmacy.contact_person}</div>}
                                            {pharmacy.phone && <div>{pharmacy.phone}</div>}
                                        </td>
                                        <td>${pharmacy.weekday_rate.toFixed(2)}/hr</td>
                                        <td>${pharmacy.weekend_rate.toFixed(2)}/hr</td>
                                        <td>${pharmacy.public_holiday_rate.toFixed(2)}/hr</td>
                                        <td>{pharmacy.apply_super ? `${pharmacy.super_rate}%` : 'No'}</td>
                                        <td>
                                            <button onClick={() => startEdit(pharmacy)}>Edit</button>
                                            <button className="danger" onClick={() => deletePharmacy(pharmacy.id)} style={{marginLeft: '8px'}}>Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : (
                        <div className="empty-state">No pharmacies added yet</div>
                    )}
                </>
            );
        };
        
        const InvoicesTab = ({ pharmacies, invoices, onUpdate, personalDetails }) => {
            const [showForm, setShowForm] = useState(false);
            const [viewInvoice, setViewInvoice] = useState(null);
            
            const deleteInvoice = (id) => {
                if (confirm('Delete this invoice? This will also delete all line items.')) {
                    try {
                        // Delete invoice line items first
                        db.run('DELETE FROM invoice_items WHERE invoice_id = ?', [id]);
                        // Delete invoice
                        db.run('DELETE FROM invoices WHERE id = ?', [id]);
                        saveDatabase();
                        onUpdate();
                    } catch (error) {
                        console.error('Error deleting invoice:', error);
                        alert('Error deleting invoice: ' + error.message);
                    }
                }
            };
            
            return (
                <>
                    <div className="button-group">
                        <button onClick={() => setShowForm(!showForm)}>
                            {showForm ? 'Cancel' : 'Create Invoice'}
                        </button>
                    </div>
                    
                    {showForm && (
                        <InvoiceForm pharmacies={pharmacies} onUpdate={onUpdate} onClose={() => setShowForm(false)} />
                    )}
                    
                    {viewInvoice && (
                        <InvoiceViewer invoice={viewInvoice} onClose={() => setViewInvoice(null)} personalDetails={personalDetails} />
                    )}
                    
                    {!showForm && !viewInvoice && (
                        <>
                            {invoices.length > 0 ? (
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Date</th>
                                            <th>Pharmacy</th>
                                            <th>Amount</th>
                                            <th>Super</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {invoices.map(invoice => (
                                            <tr key={invoice.id}>
                                                <td><strong>{invoice.invoice_number}</strong></td>
                                                <td>{formatDateForDisplay(invoice.invoice_date)}</td>
                                                <td>{invoice.pharmacy_name}</td>
                                                <td>${invoice.total_amount.toFixed(2)}</td>
                                                <td>${invoice.super_amount.toFixed(2)}</td>
                                                <td className="positive">${(invoice.total_amount + invoice.super_amount).toFixed(2)}</td>
                                                <td><span style={{color: 'var(--success-green)'}}>{invoice.status}</span></td>
                                                <td>
                                                    <button onClick={() => setViewInvoice(invoice)}>View/Print</button>
                                                    <button className="danger" onClick={() => deleteInvoice(invoice.id)} style={{marginLeft: '8px'}}>Delete</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : (
                                <div className="empty-state">No invoices created yet</div>
                            )}
                        </>
                    )}
                </>
            );
        };
        
        const RentalSection = ({ properties, income, expenses, onUpdate }) => {
            const [showPropertyForm, setShowPropertyForm] = useState(false);
            const [showIncomeForm, setShowIncomeForm] = useState(false);
            const [showBatchIncomeForm, setShowBatchIncomeForm] = useState(false);
            const [batchIncomeForm, setBatchIncomeForm] = useState({
                property_id: '',
                start_date: '',
                end_date: '',
                amount: '',
                description: ''
            });
            const [showExpenseForm, setShowExpenseForm] = useState(false);
            const [showBatchExpenseForm, setShowBatchExpenseForm] = useState(false);
            const [batchExpenseForm, setBatchExpenseForm] = useState({
                property_id: '',
                start_date: '',
                end_date: '',
                category: 'Maintenance',
                amount: '',
                description: '',
                deductible: true
            });
            const [showReceipt, setShowReceipt] = useState(false);
            const [selectedIncome, setSelectedIncome] = useState(null);
            const [editingProperty, setEditingProperty] = useState(null);
            const [editingIncome, setEditingIncome] = useState(null);
            const [editingExpense, setEditingExpense] = useState(null);
            
            const [propertyForm, setPropertyForm] = useState({
                property_name: '',
                address: '',
                monthly_rent: '',
                contract_start: '',
                contract_end: '',
                tenant_name: ''
            });
            
            const [incomeForm, setIncomeForm] = useState({
                property_id: '',
                date: '',
                amount: '',
                description: ''
            });
            
            const [expenseForm, setExpenseForm] = useState({
                property_id: '',
                date: '',
                category: 'Maintenance',
                amount: '',
                description: '',
                deductible: true
            });
            
            const addProperty = () => {
                try {
                    // Validate required fields
                    if (!propertyForm.property_name || !propertyForm.address || !propertyForm.monthly_rent) {
                        alert('Please fill in all required fields: Property Name, Address, and Monthly Rent');
                        return;
                    }
                    
                    console.log('Adding property...', propertyForm);
                    
                    if (editingProperty !== null) {
                        // Update existing property
                        console.log('Updating property ID:', editingProperty);
                        db.run(
                            'UPDATE rental_properties SET property_name = ?, address = ?, monthly_rent = ?, contract_start = ?, contract_end = ?, tenant_name = ? WHERE id = ?',
                            [propertyForm.property_name, propertyForm.address, parseFloat(propertyForm.monthly_rent) || 0, 
                             propertyForm.contract_start, propertyForm.contract_end, propertyForm.tenant_name, editingProperty]
                        );
                        setEditingProperty(null);
                    } else {
                        // Insert new property
                        console.log('Inserting new property');
                        db.run(
                            'INSERT INTO rental_properties (property_name, address, monthly_rent, contract_start, contract_end, tenant_name) VALUES (?, ?, ?, ?, ?, ?)',
                            [propertyForm.property_name, propertyForm.address, parseFloat(propertyForm.monthly_rent) || 0, 
                             propertyForm.contract_start, propertyForm.contract_end, propertyForm.tenant_name]
                        );
                    }
                    
                    console.log('Saving database...');
                    saveDatabase();
                    
                    console.log('Resetting form...');
                    setPropertyForm({ property_name: '', address: '', monthly_rent: '', contract_start: '', contract_end: '', tenant_name: '' });
                    setShowPropertyForm(false);
                    
                    console.log('Reloading data...');
                    onUpdate();
                    
                    console.log('Property saved successfully!');
                    alert('Property saved successfully!');
                } catch (error) {
                    console.error('Error saving property:', error);
                    alert('Error saving property: ' + error.message + '\n\nPlease check the browser console for more details.');
                }
            };
            
            const editProperty = (property) => {
                setPropertyForm({
                    property_name: property.property_name,
                    address: property.address,
                    monthly_rent: property.monthly_rent,
                    contract_start: property.contract_start,
                    contract_end: property.contract_end,
                    tenant_name: property.tenant_name
                });
                setEditingProperty(property.id);
                setShowPropertyForm(true);
            };
            
            const calculateRentalPeriod = (date) => {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = d.getMonth();
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                const formatDate = (date) => {
                    const day = date.getDate();
                    const m = date.getMonth() + 1;
                    const y = date.getFullYear().toString().slice(-2);
                    return `${day}/${m}/${y}`;
                };
                
                return `${formatDate(firstDay)} - ${formatDate(lastDay)}`;
            };
            
            const addIncome = () => {
                const rentalPeriod = incomeForm.rental_period || calculateRentalPeriod(incomeForm.date);
                
                if (editingIncome !== null) {
                    // Update existing income
                    db.run(
                        'UPDATE rental_income SET property_id = ?, date = ?, amount = ?, description = ?, rental_period = ? WHERE id = ?',
                        [parseInt(incomeForm.property_id), incomeForm.date, parseFloat(incomeForm.amount), incomeForm.description, rentalPeriod, editingIncome]
                    );
                    setEditingIncome(null);
                } else {
                    // Insert new income
                    db.run(
                        'INSERT INTO rental_income (property_id, date, amount, description, rental_period) VALUES (?, ?, ?, ?, ?)',
                        [parseInt(incomeForm.property_id), incomeForm.date, parseFloat(incomeForm.amount), incomeForm.description, rentalPeriod]
                    );
                }
                saveDatabase();
                setIncomeForm({ property_id: '', date: '', amount: '', description: '', rental_period: '' });
                setShowIncomeForm(false);
                onUpdate();
            };
            
            const calculateMonthsBetween = (startDate, endDate) => {
                const start = new Date(startDate);
                const end = new Date(endDate);
                let months = 0;
                let current = new Date(start);
                
                while (current <= end) {
                    months++;
                    current.setMonth(current.getMonth() + 1);
                }
                
                return months;
            };
            
            const addBatchIncome = () => {
                if (!batchIncomeForm.property_id || !batchIncomeForm.start_date || !batchIncomeForm.end_date || !batchIncomeForm.amount) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                const start = new Date(batchIncomeForm.start_date);
                const end = new Date(batchIncomeForm.end_date);
                
                if (start > end) {
                    alert('Start date must be before end date');
                    return;
                }
                
                let current = new Date(start);
                let count = 0;
                
                // Add income for each month
                while (current <= end) {
                    const year = current.getFullYear();
                    const month = (current.getMonth() + 1).toString().padStart(2, '0');
                    const day = current.getDate().toString().padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    const rentalPeriod = calculateRentalPeriod(dateStr);
                    
                    db.run(
                        'INSERT INTO rental_income (property_id, date, amount, description, rental_period) VALUES (?, ?, ?, ?, ?)',
                        [parseInt(batchIncomeForm.property_id), dateStr, parseFloat(batchIncomeForm.amount), batchIncomeForm.description, rentalPeriod]
                    );
                    
                    count++;
                    current.setMonth(current.getMonth() + 1);
                }
                
                saveDatabase();
                setBatchIncomeForm({ property_id: '', start_date: '', end_date: '', amount: '', description: '' });
                setShowBatchIncomeForm(false);
                onUpdate();
                
                if (confirm(` Added ${count} monthly income records.\n\nWould you like to add another batch?`)) {
                    setShowBatchIncomeForm(true);
                    if (properties.length === 1) {
                        setBatchIncomeForm({ 
                            property_id: properties[0].id.toString(), 
                            start_date: '', 
                            end_date: '',
                            amount: properties[0].monthly_rent, 
                            description: '' 
                        });
                    }
                }
            };
            
            const addBatchExpense = () => {
                if (!batchExpenseForm.property_id || !batchExpenseForm.start_date || !batchExpenseForm.end_date || !batchExpenseForm.amount) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                const start = new Date(batchExpenseForm.start_date);
                const end = new Date(batchExpenseForm.end_date);
                
                if (start > end) {
                    alert('Start date must be before end date');
                    return;
                }
                
                let current = new Date(start);
                let count = 0;
                
                // Add expense for each month
                while (current <= end) {
                    const year = current.getFullYear();
                    const month = (current.getMonth() + 1).toString().padStart(2, '0');
                    const day = current.getDate().toString().padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    db.run(
                        'INSERT INTO rental_expenses (property_id, date, category, amount, description, deductible) VALUES (?, ?, ?, ?, ?, ?)',
                        [parseInt(batchExpenseForm.property_id), dateStr, batchExpenseForm.category, parseFloat(batchExpenseForm.amount), 
                         batchExpenseForm.description, batchExpenseForm.deductible ? 1 : 0]
                    );
                    
                    count++;
                    current.setMonth(current.getMonth() + 1);
                }
                
                saveDatabase();
                setBatchExpenseForm({ property_id: '', start_date: '', end_date: '', category: 'Maintenance', amount: '', description: '', deductible: true });
                setShowBatchExpenseForm(false);
                onUpdate();
                
                if (confirm(` Added ${count} monthly expense records.\n\nWould you like to add another batch?`)) {
                    setShowBatchExpenseForm(true);
                    if (properties.length === 1) {
                        setBatchExpenseForm({ 
                            property_id: properties[0].id.toString(), 
                            start_date: '', 
                            end_date: '',
                            category: 'Maintenance',
                            amount: '', 
                            description: '',
                            deductible: true
                        });
                    }
                }
            };
            
            const editIncome = (incomeRecord) => {
                setIncomeForm({
                    property_id: incomeRecord.property_id,
                    date: incomeRecord.date,
                    amount: incomeRecord.amount,
                    description: incomeRecord.description,
                    rental_period: incomeRecord.rental_period || ''
                });
                setEditingIncome(incomeRecord.id);
                setShowIncomeForm(true);
            };
            
            const addExpense = () => {
                if (editingExpense !== null) {
                    // Update existing expense
                    db.run(
                        'UPDATE rental_expenses SET property_id = ?, date = ?, category = ?, amount = ?, description = ?, deductible = ? WHERE id = ?',
                        [parseInt(expenseForm.property_id), expenseForm.date, expenseForm.category, parseFloat(expenseForm.amount), 
                         expenseForm.description, expenseForm.deductible ? 1 : 0, editingExpense]
                    );
                    setEditingExpense(null);
                } else {
                    // Insert new expense
                    db.run(
                        'INSERT INTO rental_expenses (property_id, date, category, amount, description, deductible) VALUES (?, ?, ?, ?, ?, ?)',
                        [parseInt(expenseForm.property_id), expenseForm.date, expenseForm.category, parseFloat(expenseForm.amount), 
                         expenseForm.description, expenseForm.deductible ? 1 : 0]
                    );
                }
                saveDatabase();
                setExpenseForm({ property_id: '', date: '', category: 'Maintenance', amount: '', description: '', deductible: true });
                setShowExpenseForm(false);
                onUpdate();
            };
            
            const editExpense = (expenseRecord) => {
                setExpenseForm({
                    property_id: expenseRecord.property_id,
                    date: expenseRecord.date,
                    category: expenseRecord.category,
                    amount: expenseRecord.amount,
                    description: expenseRecord.description,
                    deductible: expenseRecord.deductible
                });
                setEditingExpense(expenseRecord.id);
                setShowExpenseForm(true);
            };
            
            const cancelEdit = () => {
                setEditingProperty(null);
                setEditingIncome(null);
                setEditingExpense(null);
                setPropertyForm({ property_name: '', address: '', monthly_rent: '', contract_start: '', contract_end: '', tenant_name: '' });
                setIncomeForm({ property_id: '', date: '', amount: '', description: '' });
                setExpenseForm({ property_id: '', date: '', category: 'Maintenance', amount: '', description: '', deductible: true });
                setShowPropertyForm(false);
                setShowIncomeForm(false);
                setShowExpenseForm(false);
            };
            
            const deleteProperty = (id) => {
                if (confirm('Delete this property and all associated records?')) {
                    db.run('DELETE FROM rental_income WHERE property_id = ?', [id]);
                    db.run('DELETE FROM rental_expenses WHERE property_id = ?', [id]);
                    db.run('DELETE FROM rental_properties WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const deleteIncome = (id) => {
                if (confirm('Delete this income record?')) {
                    db.run('DELETE FROM rental_income WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const deleteExpense = (id) => {
                if (confirm('Delete this expense record?')) {
                    db.run('DELETE FROM rental_expenses WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const printReceipt = (incomeRecord) => {
                const property = properties.find(p => p.id === incomeRecord.property_id);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Receipt Header
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('RENTAL PAYMENT RECEIPT', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Tan Pham - Incomes and expenses', 105, 28, { align: 'center' });
                
                // Line separator
                doc.setLineWidth(0.5);
                doc.line(20, 35, 190, 35);
                
                // Receipt details
                doc.setFontSize(12);
                let y = 50;
                
                doc.setFont(undefined, 'bold');
                doc.text('Receipt Number:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(`#${incomeRecord.id.toString().padStart(6, '0')}`, 80, y);
                
                y += 10;
                const receiptDate = new Date();
                doc.setFont(undefined, 'bold');
                doc.text('Receipt Date:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(receiptDate.toLocaleDateString('en-AU'), 80, y);
                
                y += 20;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Property Details', 20, y);
                
                y += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Address:', 20, y);
                doc.setFont(undefined, 'normal');
                const addressLines = doc.splitTextToSize(property?.address || 'N/A', 110);
                doc.text(addressLines, 80, y);
                y += (addressLines.length - 1) * 6;
                
                if (property?.tenant_name) {
                    y += 8;
                    doc.setFont(undefined, 'bold');
                    doc.text('Tenant Name:', 20, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(property.tenant_name, 80, y);
                }
                
                // Use rental period from database, or calculate if not available
                let rentalPeriod = incomeRecord.rental_period;
                if (!rentalPeriod) {
                    // Fallback: Calculate from income date
                    const incomeDate = new Date(incomeRecord.date);
                    const month = incomeDate.getMonth();
                    const year = incomeDate.getFullYear();
                    
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    
                    const formatDate = (date) => {
                        const d = date.getDate();
                        const m = date.getMonth() + 1;
                        const y = date.getFullYear().toString().slice(-2);
                        return `${d}/${m}/${y}`;
                    };
                    
                    rentalPeriod = `${formatDate(firstDay)} - ${formatDate(lastDay)}`;
                }
                
                y += 8;
                doc.setFont(undefined, 'bold');
                doc.text('Rental Period:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(rentalPeriod, 80, y);
                
                y += 20;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Payment Details', 20, y);
                
                y += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Description:', 20, y);
                doc.setFont(undefined, 'normal');
                const descLines = doc.splitTextToSize(incomeRecord.description || 'Rental Payment', 110);
                doc.text(descLines, 80, y);
                y += descLines.length * 6;
                
                y += 10;
                // Amount box
                doc.setFillColor(240, 240, 240);
                doc.rect(20, y - 8, 170, 15, 'F');
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Amount Paid:', 25, y);
                doc.setTextColor(16, 185, 129);
                doc.text(`$${parseFloat(incomeRecord.amount).toFixed(2)} AUD`, 150, y);
                doc.setTextColor(0, 0, 0);
                
                // Footer
                y += 40;
                doc.setLineWidth(0.5);
                doc.line(20, y, 190, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'italic');
                doc.text('This is a computer-generated receipt and does not require a signature.', 105, y, { align: 'center' });
                y += 6;
                doc.text('Generated from Tan Pham - Incomes and expenses', 105, y, { align: 'center' });
                y += 6;
                doc.text(`Generated on: ${new Date().toLocaleString('en-AU')}`, 105, y, { align: 'center' });
                
                // Save the PDF
                doc.save(`receipt-${incomeRecord.id}-${receiptDate.toISOString().split('T')[0]}.pdf`);
            };
            
            const totalIncome = income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = expenses.reduce((sum, item) => sum + item.amount, 0);
            const netIncome = totalIncome - totalExpenses;
            
            return (
                <>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Rental Income</div>
                            <div className="stat-value positive">{formatCurrency(totalIncome)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Total Expenses</div>
                            <div className="stat-value negative">{formatCurrency(totalExpenses)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Net Rental Income</div>
                            <div className={`stat-value ${netIncome >= 0 ? 'positive' : 'negative'}`}>
                                {formatCurrency(netIncome)}
                            </div>
                        </div>
                    </div>
                    
                    <div className="section">
                        <h2> Properties</h2>
                        <div className="button-group">
                            <button onClick={() => {
                                if (!showPropertyForm) {
                                    setEditingProperty(null);
                                    setPropertyForm({ property_name: '', address: '', monthly_rent: '', contract_start: '', contract_end: '', tenant_name: '' });
                                }
                                setShowPropertyForm(!showPropertyForm);
                            }}>
                                {showPropertyForm ? 'Cancel' : 'Add Property'}
                            </button>
                        </div>
                        
                        {showPropertyForm && (
                            <div className="form-grid" style={{marginTop: '20px'}}>
                                <div className="form-group">
                                    <label>Property Name</label>
                                    <input 
                                        type="text" 
                                        value={propertyForm.property_name}
                                        onChange={(e) => setPropertyForm({...propertyForm, property_name: e.target.value})}
                                        placeholder="e.g., Unit 5, Brighton Apartments"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Address</label>
                                    <input 
                                        type="text" 
                                        value={propertyForm.address}
                                        onChange={(e) => setPropertyForm({...propertyForm, address: e.target.value})}
                                        placeholder="123 Main St, Melbourne VIC"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Monthly Rent ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={propertyForm.monthly_rent}
                                        onChange={(e) => setPropertyForm({...propertyForm, monthly_rent: e.target.value})}
                                        placeholder="2500.00"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Contract Start Date</label>
                                    <input 
                                        type="date" 
                                        value={propertyForm.contract_start}
                                        onChange={(e) => setPropertyForm({...propertyForm, contract_start: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Contract End Date</label>
                                    <input 
                                        type="date" 
                                        value={propertyForm.contract_end}
                                        onChange={(e) => setPropertyForm({...propertyForm, contract_end: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Tenant Name</label>
                                    <input 
                                        type="text" 
                                        value={propertyForm.tenant_name}
                                        onChange={(e) => setPropertyForm({...propertyForm, tenant_name: e.target.value})}
                                        placeholder="John Smith"
                                    />
                                </div>
                                <div className="form-group" style={{display: 'flex', alignItems: 'flex-end', gap: '10px'}}>
                                    <button onClick={addProperty}>
                                        {editingProperty !== null ? 'Update Property' : 'Save Property'}
                                    </button>
                                    {editingProperty !== null && (
                                        <button className="secondary" onClick={cancelEdit}>Cancel</button>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {properties.length > 0 ? (
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Property Name</th>
                                        <th>Address</th>
                                        <th>Monthly Rent</th>
                                        <th>Contract Period</th>
                                        <th>Tenant</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {properties.map(prop => (
                                        <tr key={prop.id}>
                                            <td><strong>{prop.property_name}</strong></td>
                                            <td>{prop.address}</td>
                                            <td className="positive">${parseFloat(prop.monthly_rent || 0).toFixed(2)}/mo</td>
                                            <td>
                                                {prop.contract_start && prop.contract_end 
                                                    ? `${formatDateForDisplay(prop.contract_start)} to ${formatDateForDisplay(prop.contract_end)}`
                                                    : 'N/A'}
                                            </td>
                                            <td>{prop.tenant_name}</td>
                                            <td>
                                                <div className="action-buttons">
                                                    <button className="secondary" onClick={() => editProperty(prop)}>Edit</button>
                                                    <button className="danger" onClick={() => deleteProperty(prop.id)}>Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div className="empty-state">No properties added yet</div>
                        )}
                    </div>
                    
                    <div className="section">
                        <h2> Rental Income</h2>
                        <div className="button-group">
                            <button onClick={() => {
                                if (!showIncomeForm) {
                                    setEditingIncome(null);
                                    // If only one property exists, auto-select it
                                    if (properties.length === 1) {
                                        setIncomeForm({ 
                                            property_id: properties[0].id.toString(), 
                                            date: '', 
                                            amount: properties[0].monthly_rent, 
                                            description: '' 
                                        });
                                    } else {
                                        setIncomeForm({ property_id: '', date: '', amount: '', description: '' });
                                    }
                                }
                                setShowIncomeForm(!showIncomeForm);
                                setShowBatchIncomeForm(false);
                            }}>
                                {showIncomeForm ? 'Cancel' : 'Add Income'}
                            </button>
                            <button onClick={() => {
                                setShowBatchIncomeForm(!showBatchIncomeForm);
                                setShowIncomeForm(false);
                                if (!showBatchIncomeForm) {
                                    // If only one property exists, auto-select it
                                    if (properties.length === 1) {
                                        setBatchIncomeForm({ 
                                            property_id: properties[0].id.toString(), 
                                            start_date: '', 
                                            end_date: '',
                                            amount: properties[0].monthly_rent, 
                                            description: '' 
                                        });
                                    } else {
                                        setBatchIncomeForm({ property_id: '', start_date: '', end_date: '', amount: '', description: '' });
                                    }
                                }
                            }} style={{background: '#f59e0b'}}>
                                {showBatchIncomeForm ? 'Cancel' : 'Batch Add Income'}
                            </button>
                        </div>
                        
                        {showBatchIncomeForm && (
                            <div className="form-grid" style={{marginTop: '20px', padding: '20px', background: '#fef3c7', borderRadius: '8px'}}>
                                <h3 style={{gridColumn: '1 / -1', margin: '0 0 15px 0'}}> Batch Add Monthly Income</h3>
                                <div className="form-group">
                                    <label>Property</label>
                                    <select 
                                        value={batchIncomeForm.property_id}
                                        onChange={(e) => {
                                            const selectedPropertyId = e.target.value;
                                            const selectedProperty = properties.find(p => p.id === parseInt(selectedPropertyId));
                                            setBatchIncomeForm({
                                                ...batchIncomeForm, 
                                                property_id: selectedPropertyId,
                                                amount: selectedProperty ? selectedProperty.monthly_rent : ''
                                            });
                                        }}>
                                        <option value="">Select Property</option>
                                        {properties.map(p => <option key={p.id} value={p.id}>{p.property_name}</option>)}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Start Date (First Month)</label>
                                    <input type="date" value={batchIncomeForm.start_date} onChange={(e) => setBatchIncomeForm({...batchIncomeForm, start_date: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>End Date (Last Month)</label>
                                    <input type="date" value={batchIncomeForm.end_date} onChange={(e) => setBatchIncomeForm({...batchIncomeForm, end_date: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Monthly Amount ($)</label>
                                    <input type="number" step="0.01" value={batchIncomeForm.amount} onChange={(e) => setBatchIncomeForm({...batchIncomeForm, amount: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Description (optional)</label>
                                    <input type="text" value={batchIncomeForm.description} onChange={(e) => setBatchIncomeForm({...batchIncomeForm, description: e.target.value})} />
                                </div>
                                <div className="form-group" style={{display: 'flex', alignItems: 'flex-end'}}>
                                    <button onClick={addBatchIncome}>Save Batch</button>
                                </div>
                                {batchIncomeForm.start_date && batchIncomeForm.end_date && (
                                    <div style={{gridColumn: '1 / -1', padding: '10px', background: 'white', borderRadius: '6px', fontSize: '0.9em'}}>
                                        <strong>Preview:</strong> This will add {calculateMonthsBetween(batchIncomeForm.start_date, batchIncomeForm.end_date)} monthly income records from {new Date(batchIncomeForm.start_date).toLocaleDateString('en-AU', {month: 'long', year: 'numeric'})} to {new Date(batchIncomeForm.end_date).toLocaleDateString('en-AU', {month: 'long', year: 'numeric'})}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {showIncomeForm && (
                            <div className="form-grid" style={{marginTop: '20px'}}>
                                <div className="form-group">
                                    <label>Property</label>
                                    <select 
                                        value={incomeForm.property_id}
                                        onChange={(e) => {
                                            const selectedPropertyId = e.target.value;
                                            const selectedProperty = properties.find(p => p.id === parseInt(selectedPropertyId));
                                            setIncomeForm({
                                                ...incomeForm, 
                                                property_id: selectedPropertyId,
                                                amount: selectedProperty ? selectedProperty.monthly_rent : ''
                                            });
                                        }}
                                    >
                                        <option value="">Select Property</option>
                                        {properties.map(prop => (
                                            <option key={prop.id} value={prop.id}>{prop.property_name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Date</label>
                                    <input 
                                        type="date" 
                                        value={incomeForm.date}
                                        onChange={(e) => {
                                            const newDate = e.target.value;
                                            const calculatedPeriod = newDate ? calculateRentalPeriod(newDate) : '';
                                            setIncomeForm({...incomeForm, date: newDate, rental_period: calculatedPeriod});
                                        }}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Rental Period</label>
                                    <input 
                                        type="text" 
                                        value={incomeForm.rental_period || ''}
                                        onChange={(e) => setIncomeForm({...incomeForm, rental_period: e.target.value})}
                                        placeholder="e.g., 1/5/25 - 31/5/25"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Amount ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={incomeForm.amount}
                                        onChange={(e) => setIncomeForm({...incomeForm, amount: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Description</label>
                                    <input 
                                        type="text" 
                                        value={incomeForm.description}
                                        onChange={(e) => setIncomeForm({...incomeForm, description: e.target.value})}
                                        placeholder="Monthly rent payment"
                                    />
                                </div>
                                <div className="form-group" style={{display: 'flex', alignItems: 'flex-end', gap: '10px'}}>
                                    <button onClick={addIncome}>
                                        {editingIncome !== null ? 'Update Income' : 'Save Income'}
                                    </button>
                                    {editingIncome !== null && (
                                        <button className="secondary" onClick={cancelEdit}>Cancel</button>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {income.length > 0 ? (
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Date</th>
                                        <th>Rental Period</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {income.map(item => (
                                        <tr key={item.id}>
                                            <td>{item.property_name}</td>
                                            <td>{formatDateForDisplay(item.date)}</td>
                                            <td><strong>{item.rental_period || 'N/A'}</strong></td>
                                            <td className="positive">${parseFloat(item.amount).toFixed(2)}</td>
                                            <td>{item.description}</td>
                                            <td>
                                                <div className="action-buttons">
                                                    <button className="success" onClick={() => printReceipt(item)}>Print Receipt</button>
                                                    <button className="secondary" onClick={() => editIncome(item)}>Edit</button>
                                                    <button className="danger" onClick={() => deleteIncome(item.id)}>Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div className="empty-state">No income records yet</div>
                        )}
                    </div>
                    
                    <div className="section">
                        <h2> Rental Expenses</h2>
                        <div className="button-group">
                            <button onClick={() => {
                                if (!showExpenseForm) {
                                    setEditingExpense(null);
                                    // If only one property exists, auto-select it
                                    if (properties.length === 1) {
                                        setExpenseForm({ 
                                            property_id: properties[0].id.toString(), 
                                            date: '', 
                                            category: 'Maintenance', 
                                            amount: '', 
                                            description: '', 
                                            deductible: true 
                                        });
                                    } else {
                                        setExpenseForm({ property_id: '', date: '', category: 'Maintenance', amount: '', description: '', deductible: true });
                                    }
                                }
                                setShowExpenseForm(!showExpenseForm);
                                setShowBatchExpenseForm(false);
                            }}>
                                {showExpenseForm ? 'Cancel' : 'Add Expense'}
                            </button>
                            <button onClick={() => {
                                setShowBatchExpenseForm(!showBatchExpenseForm);
                                setShowExpenseForm(false);
                                if (!showBatchExpenseForm) {
                                    // If only one property exists, auto-select it
                                    if (properties.length === 1) {
                                        setBatchExpenseForm({ 
                                            property_id: properties[0].id.toString(), 
                                            start_date: '', 
                                            end_date: '',
                                            category: 'Maintenance',
                                            amount: '', 
                                            description: '',
                                            deductible: true
                                        });
                                    } else {
                                        setBatchExpenseForm({ property_id: '', start_date: '', end_date: '', category: 'Maintenance', amount: '', description: '', deductible: true });
                                    }
                                }
                            }} style={{background: '#f59e0b'}}>
                                {showBatchExpenseForm ? 'Cancel' : 'Batch Add Expense'}
                            </button>
                        </div>
                        
                        {showBatchExpenseForm && (
                            <div className="form-grid" style={{marginTop: '20px', padding: '20px', background: '#fef3c7', borderRadius: '8px'}}>
                                <h3 style={{gridColumn: '1 / -1', margin: '0 0 15px 0'}}> Batch Add Monthly Expenses</h3>
                                <div className="form-group">
                                    <label>Property</label>
                                    <select 
                                        value={batchExpenseForm.property_id}
                                        onChange={(e) => setBatchExpenseForm({...batchExpenseForm, property_id: e.target.value})}>
                                        <option value="">Select Property</option>
                                        {properties.map(p => <option key={p.id} value={p.id}>{p.property_name}</option>)}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Start Date (First Month)</label>
                                    <input type="date" value={batchExpenseForm.start_date} onChange={(e) => setBatchExpenseForm({...batchExpenseForm, start_date: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>End Date (Last Month)</label>
                                    <input type="date" value={batchExpenseForm.end_date} onChange={(e) => setBatchExpenseForm({...batchExpenseForm, end_date: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Category</label>
                                    <select value={batchExpenseForm.category} onChange={(e) => setBatchExpenseForm({...batchExpenseForm, category: e.target.value})}>
                                        <option>Maintenance</option>
                                        <option>Repairs</option>
                                        <option>Insurance</option>
                                        <option>Property Management</option>
                                        <option>Council Rates</option>
                                        <option>Water Rates</option>
                                        <option>Strata Fees</option>
                                        <option>Utilities allowance - Liabilities</option>
                                        <option>Advertising</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Monthly Amount ($)</label>
                                    <input type="number" step="0.01" value={batchExpenseForm.amount} onChange={(e) => setBatchExpenseForm({...batchExpenseForm, amount: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Description</label>
                                    <input type="text" value={batchExpenseForm.description} onChange={(e) => setBatchExpenseForm({...batchExpenseForm, description: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <input 
                                            type="checkbox" 
                                            checked={batchExpenseForm.deductible}
                                            onChange={(e) => setBatchExpenseForm({...batchExpenseForm, deductible: e.target.checked})}
                                            style={{width: 'auto'}}
                                        />
                                        Tax Deductible
                                    </label>
                                </div>
                                <div className="form-group" style={{display: 'flex', alignItems: 'flex-end'}}>
                                    <button onClick={addBatchExpense}>Save Batch</button>
                                </div>
                                {batchExpenseForm.start_date && batchExpenseForm.end_date && (
                                    <div style={{gridColumn: '1 / -1', padding: '10px', background: 'white', borderRadius: '6px', fontSize: '0.9em'}}>
                                        <strong>Preview:</strong> This will add {calculateMonthsBetween(batchExpenseForm.start_date, batchExpenseForm.end_date)} monthly expense records from {new Date(batchExpenseForm.start_date).toLocaleDateString('en-AU', {month: 'long', year: 'numeric'})} to {new Date(batchExpenseForm.end_date).toLocaleDateString('en-AU', {month: 'long', year: 'numeric'})}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {showExpenseForm && (
                            <div className="form-grid" style={{marginTop: '20px'}}>
                                <div className="form-group">
                                    <label>Property</label>
                                    <select 
                                        value={expenseForm.property_id}
                                        onChange={(e) => setExpenseForm({...expenseForm, property_id: e.target.value})}
                                    >
                                        <option value="">Select Property</option>
                                        {properties.map(prop => (
                                            <option key={prop.id} value={prop.id}>{prop.property_name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Date</label>
                                    <input 
                                        type="date" 
                                        value={expenseForm.date}
                                        onChange={(e) => setExpenseForm({...expenseForm, date: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Category</label>
                                    <select 
                                        value={expenseForm.category}
                                        onChange={(e) => setExpenseForm({...expenseForm, category: e.target.value})}
                                    >
                                        <option>Maintenance</option>
                                        <option>Repairs</option>
                                        <option>Insurance</option>
                                        <option>Council Rates</option>
                                        <option>Body corporate fee</option>
                                        <option>Water</option>
                                        <option>Utilities allowance - Liabilities</option>
                                        <option>Property Management</option>
                                        <option>Interest on Loan</option>
                                        <option>Depreciation</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Amount ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={expenseForm.amount}
                                        onChange={(e) => setExpenseForm({...expenseForm, amount: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Description</label>
                                    <input 
                                        type="text" 
                                        value={expenseForm.description}
                                        onChange={(e) => setExpenseForm({...expenseForm, description: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <input 
                                            type="checkbox" 
                                            checked={expenseForm.deductible}
                                            onChange={(e) => setExpenseForm({...expenseForm, deductible: e.target.checked})}
                                            style={{width: 'auto'}}
                                        />
                                        Tax Deductible
                                    </label>
                                </div>
                                <div className="form-group" style={{display: 'flex', alignItems: 'flex-end', gap: '10px'}}>
                                    <button onClick={addExpense}>
                                        {editingExpense !== null ? 'Update Expense' : 'Save Expense'}
                                    </button>
                                    {editingExpense !== null && (
                                        <button className="secondary" onClick={cancelEdit}>Cancel</button>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {expenses.length > 0 ? (
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Deductible</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {expenses.map(item => (
                                        <tr key={item.id}>
                                            <td>{item.property_name}</td>
                                            <td>{formatDateForDisplay(item.date)}</td>
                                            <td>{item.category}</td>
                                            <td className="negative">${parseFloat(item.amount).toFixed(2)}</td>
                                            <td>{item.description}</td>
                                            <td>{item.deductible ? '' : ''}</td>
                                            <td>
                                                <div className="action-buttons">
                                                    <button className="secondary" onClick={() => editExpense(item)}>Edit</button>
                                                    <button className="danger" onClick={() => deleteExpense(item.id)}>Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div className="empty-state">No expense records yet</div>
                        )}
                    </div>
                </>
            );
        };
        
        const SharesSection = ({ trades, onUpdate }) => {
            const [showForm, setShowForm] = useState(false);
            const [uploadingPDF, setUploadingPDF] = useState(false);
            const [uploadingBatchPDF, setUploadingBatchPDF] = useState(false);
            const [batchProgress, setBatchProgress] = useState('');
            const [form, setForm] = useState({
                date: '',
                ticker: '',
                transaction_type: 'BUY',
                quantity: '',
                price: '',
                fees: '',
                notes: ''
            });
            
            const handlePDFUpload = async (event) => {
                const file = event.target.files[0];
                if (!file || file.type !== 'application/pdf') {
                    alert('Please upload a PDF file');
                    event.target.value = '';
                    return;
                }
                
                setUploadingPDF(true);
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const typedArray = new Uint8Array(arrayBuffer);
                    
                    // Load PDF
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;
                    const page = await pdf.getPage(1);
                    const textContent = await page.getTextContent();
                    const text = textContent.items.map(item => item.str).join(' ');
                    
                    console.log('=== EXTRACTED TEXT ===');
                    console.log(text);
                    console.log('=====================');
                    
                    // Parse the contract
                    const parsed = parseCommSecContract(text);
                    
                    if (parsed && parsed.ticker) {
                        setForm(parsed);
                        setShowForm(true);
                    } else {
                        alert(' Could not parse contract. Please enter manually.');
                        setShowForm(true);
                    }
                } catch (error) {
                    console.error('PDF parsing error:', error);
                    alert('Error reading PDF: ' + error.message);
                }
                
                setUploadingPDF(false);
                event.target.value = '';
            };
            
            const handleBatchPDFUpload = async (event) => {
                const files = Array.from(event.target.files);
                if (!files || files.length === 0) {
                    return;
                }
                
                // Filter only PDF files
                const pdfFiles = files.filter(file => file.type === 'application/pdf');
                if (pdfFiles.length === 0) {
                    alert('Please upload PDF files');
                    event.target.value = '';
                    return;
                }
                
                setUploadingBatchPDF(true);
                let successCount = 0;
                let failCount = 0;
                let duplicateCount = 0;
                
                for (let i = 0; i < pdfFiles.length; i++) {
                    const file = pdfFiles[i];
                    setBatchProgress(`${i + 1}/${pdfFiles.length}`);
                    
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const typedArray = new Uint8Array(arrayBuffer);
                        
                        // Load PDF
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        const page = await pdf.getPage(1);
                        const textContent = await page.getTextContent();
                        const text = textContent.items.map(item => item.str).join(' ');
                        
                        // Parse the contract
                        const parsed = parseCommSecContract(text);
                        
                        if (parsed && parsed.ticker && parsed.quantity && parsed.price) {
                            // Check for duplicates
                            const duplicateCheck = db.exec(
                                'SELECT * FROM shares_trades WHERE date = ? AND ticker = ? AND transaction_type = ? AND quantity = ? AND price = ?',
                                [parsed.date, parsed.ticker.toUpperCase(), parsed.transaction_type, parseFloat(parsed.quantity), parseFloat(parsed.price)]
                            );
                            
                            if (duplicateCheck.length > 0 && duplicateCheck[0].values.length > 0) {
                                // Duplicate found, skip
                                duplicateCount++;
                                console.log(`Skipped duplicate: ${parsed.ticker} on ${parsed.date}`);
                            } else {
                                // Add trade
                                db.run(
                                    'INSERT INTO shares_trades (date, ticker, transaction_type, quantity, price, fees, notes) VALUES (?, ?, ?, ?, ?, ?, ?)',
                                    [parsed.date, parsed.ticker.toUpperCase(), parsed.transaction_type, parseFloat(parsed.quantity), 
                                     parseFloat(parsed.price), parseFloat(parsed.fees) || 0, parsed.notes]
                                );
                                successCount++;
                            }
                        } else {
                            failCount++;
                            console.log(`Failed to parse: ${file.name}`);
                        }
                    } catch (error) {
                        console.error(`Error processing ${file.name}:`, error);
                        failCount++;
                    }
                }
                
                saveDatabase();
                onUpdate();
                setUploadingBatchPDF(false);
                setBatchProgress('');
                event.target.value = '';
                
                // Show summary
                let message = ` Batch Upload Complete!\n\n`;
                message += ` Successfully added: ${successCount}\n`;
                if (duplicateCount > 0) message += ` Skipped duplicates: ${duplicateCount}\n`;
                if (failCount > 0) message += ` Failed to parse: ${failCount}\n`;
                message += `\nTotal files processed: ${pdfFiles.length}`;
                
                alert(message);
            };
            
            const calculateBrokerageFee = (quantity, price) => {
                const transactionValue = quantity * price;
                
                // CommSec fee structure
                if (transactionValue <= 1000) {
                    return 5.00;
                } else if (transactionValue <= 3000) {
                    return 10.00;
                } else if (transactionValue <= 10000) {
                    return 19.95;
                } else if (transactionValue <= 25000) {
                    return 29.95;
                } else {
                    // Over $25,000: 0.12% of transaction value
                    return transactionValue * 0.0012;
                }
            };
            
            const parseCommSecContract = (text) => {
                try {
                    console.log('=== FULL EXTRACTED TEXT ===');
                    console.log(text);
                    console.log('===========================');
                    
                    // Extract transaction type
                    const isBuy = text.includes('WE HAVE BOUGHT') || text.includes('BUY');
                    const transaction_type = isBuy ? 'BUY' : 'SELL';
                    console.log('Transaction type:', transaction_type);
                    
                    // Extract date - try multiple patterns
                    let date = '';
                    console.log('--- Searching for DATE ---');
                    
                    // Try to find all dates in the text
                    const allDates = text.match(/(\d{2})\/(\d{2})\/(\d{4})/g);
                    console.log('All dates found:', allDates);
                    
                    // Look specifically for "DATE:" or "AS AT DATE:"
                    let dateMatch = text.match(/(?:^|\s)DATE:\s*(\d{2})\/(\d{2})\/(\d{4})/);
                    if (!dateMatch) {
                        dateMatch = text.match(/AS AT DATE:\s*(\d{2})\/(\d{2})\/(\d{4})/);
                    }
                    
                    if (dateMatch) {
                        const [_, day, month, year] = dateMatch;
                        date = `${year}-${month}-${day}`;
                        console.log('Found date:', dateMatch[0], '', date);
                    } else if (allDates && allDates.length > 0) {
                        // Use first date found as fallback
                        const [day, month, year] = allDates[0].split('/');
                        date = `${year}-${month}-${day}`;
                        console.log('Using first date (fallback):', allDates[0], '', date);
                    }
                    
                    // Extract ticker
                    let ticker = '';
                    console.log('--- Searching for TICKER ---');
                    
                    const lines = text.split(/\s{2,}|\n/);
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (/^[A-Z]{3,4}$/.test(trimmed)) {
                            const exclude = ['THE', 'FOR', 'YOU', 'GST', 'AUD', 'BUY', 'SELL', 'DATE', 'AND', 'HAVE', 'PAID', 'COST', 'INCL', 'EXCL', 'FULLY', 'TOTAL', 'UNITS'];
                            if (!exclude.includes(trimmed)) {
                                ticker = trimmed;
                                console.log('Found ticker:', trimmed);
                                break;
                            }
                        }
                    }
                    
                    // Extract quantity
                    let quantity = '';
                    console.log('--- Searching for QUANTITY ---');
                    
                    // Show all numbers with commas in the text
                    const allNumbers = text.match(/\d{1,3}(?:,\d{3})+/g);
                    console.log('All formatted numbers:', allNumbers);
                    
                    // Try patterns
                    const qtyPatterns = [
                        /TOTAL\s+UNITS:\s*([\d,]+)/i,
                        /UNITS:\s*([\d,]+)/i,
                        /QUANTITY:\s*([\d,]+)/i
                    ];
                    
                    for (const pattern of qtyPatterns) {
                        const match = text.match(pattern);
                        if (match) {
                            quantity = match[1].replace(/,/g, '');
                            console.log('Found quantity with pattern:', pattern, '', match[0], '', quantity);
                            break;
                        }
                    }
                    
                    // Look in "UNITS AT PRICE" section
                    if (!quantity) {
                        const unitsSection = text.match(/UNITS AT PRICE\s+([\d,]+)/);
                        if (unitsSection) {
                            quantity = unitsSection[1].replace(/,/g, '');
                            console.log('Found quantity in UNITS AT PRICE:', quantity);
                        }
                    }
                    
                    // Extract price
                    let price = '';
                    console.log('--- Searching for PRICE ---');
                    
                    // Show all decimal numbers
                    const allDecimals = text.match(/\d+\.\d+/g);
                    console.log('All decimal numbers:', allDecimals);
                    
                    const pricePatterns = [
                        /AVERAGE\s+PRICE:\s*([\d.]+)/i,
                        /PRICE:\s*([\d.]+)/i,
                        /AT PRICE\s+([\d,]+)\s+([\d.]+)/i  // "UNITS AT PRICE 2,000 1.570000"
                    ];
                    
                    for (const pattern of pricePatterns) {
                        const match = text.match(pattern);
                        if (match) {
                            price = match[match.length - 1]; // Last capture group
                            console.log('Found price with pattern:', pattern, '', match[0], '', price);
                            break;
                        }
                    }
                    
                    // Extract fees - CALCULATE instead of parse
                    let fees = '';
                    console.log('--- CALCULATING FEES ---');
                    
                    // If we have quantity and price, calculate the fee
                    if (quantity && price) {
                        const calcFee = calculateBrokerageFee(parseFloat(quantity), parseFloat(price));
                        fees = calcFee.toFixed(2);
                        console.log('Calculated brokerage fee:', {
                            quantity: quantity,
                            price: price,
                            transactionValue: (parseFloat(quantity) * parseFloat(price)).toFixed(2),
                            fee: fees
                        });
                    } else {
                        console.log('Cannot calculate fee - missing quantity or price');
                    }
                    
                    console.log('=== FINAL PARSED RESULT ===');
                    console.log({ date, ticker, transaction_type, quantity, price, fees });
                    console.log('===========================');
                    
                    return {
                        date,
                        ticker,
                        transaction_type,
                        quantity,
                        price,
                        fees,
                        notes: 'Imported from PDF'
                    };
                } catch (error) {
                    console.error('Parse error:', error);
                    return null;
                }
            };
            
            const addTrade = () => {
                try {
                    // Check for duplicates - same date, ticker, type, quantity, and price
                    const duplicateCheck = db.exec(
                        'SELECT * FROM shares_trades WHERE date = ? AND ticker = ? AND transaction_type = ? AND quantity = ? AND price = ?',
                        [form.date, form.ticker.toUpperCase(), form.transaction_type, parseFloat(form.quantity), parseFloat(form.price)]
                    );
                    
                    if (duplicateCheck.length > 0 && duplicateCheck[0].values.length > 0) {
                        // Found potential duplicate
                        const duplicate = duplicateCheck[0].values[0];
                        const duplicateDate = duplicate[1];
                        const duplicateTicker = duplicate[2];
                        const duplicateType = duplicate[3];
                        const duplicateQty = duplicate[4];
                        const duplicatePrice = duplicate[5];
                        
                        const isDuplicate = confirm(
                            ` POSSIBLE DUPLICATE DETECTED\n\n` +
                            `Existing trade:\n` +
                            `Date: ${duplicateDate}\n` +
                            `Ticker: ${duplicateTicker}\n` +
                            `Type: ${duplicateType}\n` +
                            `Quantity: ${duplicateQty}\n` +
                            `Price: $${duplicatePrice}\n\n` +
                            `Do you want to add this trade anyway?`
                        );
                        
                        if (!isDuplicate) {
                            return; // Cancel the save
                        }
                    }
                    
                    db.run(
                        'INSERT INTO shares_trades (date, ticker, transaction_type, quantity, price, fees, notes) VALUES (?, ?, ?, ?, ?, ?, ?)',
                        [form.date, form.ticker.toUpperCase(), form.transaction_type, parseFloat(form.quantity), 
                         parseFloat(form.price), parseFloat(form.fees) || 0, form.notes]
                    );
                    saveDatabase();
                    setForm({ date: '', ticker: '', transaction_type: 'BUY', quantity: '', price: '', fees: '', notes: '' });
                    setShowForm(false);
                    onUpdate();
                } catch (error) {
                    console.error('Error saving trade:', error);
                    alert('Error saving trade: ' + error.message);
                }
            };
            
            const deleteTrade = (id) => {
                if (confirm('Delete this trade?')) {
                    db.run('DELETE FROM shares_trades WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            // Calculate P&L using FIFO method
            const calculateProfitLoss = () => {
                const positions = {};
                let totalPL = 0;
                
                trades.slice().reverse().forEach(trade => {
                    const ticker = trade.ticker;
                    if (!positions[ticker]) {
                        positions[ticker] = { shares: [], totalPL: 0 };
                    }
                    
                    if (trade.transaction_type === 'BUY') {
                        positions[ticker].shares.push({
                            quantity: trade.quantity,
                            price: trade.price,
                            fees: trade.fees
                        });
                    } else if (trade.transaction_type === 'SELL') {
                        let remainingToSell = trade.quantity;
                        let sellProceeds = (trade.quantity * trade.price) - trade.fees;
                        let costBasis = 0;
                        
                        while (remainingToSell > 0 && positions[ticker].shares.length > 0) {
                            const oldestPurchase = positions[ticker].shares[0];
                            const sellQty = Math.min(remainingToSell, oldestPurchase.quantity);
                            
                            costBasis += (sellQty * oldestPurchase.price) + (oldestPurchase.fees * sellQty / oldestPurchase.quantity);
                            
                            oldestPurchase.quantity -= sellQty;
                            if (oldestPurchase.quantity <= 0) {
                                positions[ticker].shares.shift();
                            }
                            
                            remainingToSell -= sellQty;
                        }
                        
                        const tradePL = sellProceeds - costBasis;
                        positions[ticker].totalPL += tradePL;
                        totalPL += tradePL;
                    }
                });
                
                return totalPL;
            };
            
            const calculateDetailedPL = () => {
                const positions = {};
                const transactions = [];
                
                trades.slice().reverse().forEach(trade => {
                    const ticker = trade.ticker;
                    if (!positions[ticker]) {
                        positions[ticker] = { shares: [] };
                    }
                    
                    if (trade.transaction_type === 'BUY') {
                        positions[ticker].shares.push({
                            date: trade.date,
                            quantity: trade.quantity,
                            price: trade.price,
                            fees: trade.fees
                        });
                    } else if (trade.transaction_type === 'SELL') {
                        let remainingToSell = trade.quantity;
                        let sellProceeds = (trade.quantity * trade.price) - trade.fees;
                        let costBasis = 0;
                        const matchedBuys = [];
                        
                        while (remainingToSell > 0 && positions[ticker].shares.length > 0) {
                            const oldestPurchase = positions[ticker].shares[0];
                            const sellQty = Math.min(remainingToSell, oldestPurchase.quantity);
                            
                            const purchaseCost = (sellQty * oldestPurchase.price) + (oldestPurchase.fees * sellQty / oldestPurchase.quantity);
                            costBasis += purchaseCost;
                            
                            matchedBuys.push({
                                buyDate: oldestPurchase.date,
                                buyPrice: oldestPurchase.price,
                                quantity: sellQty
                            });
                            
                            oldestPurchase.quantity -= sellQty;
                            if (oldestPurchase.quantity <= 0) {
                                positions[ticker].shares.shift();
                            }
                            
                            remainingToSell -= sellQty;
                        }
                        
                        const tradePL = sellProceeds - costBasis;
                        
                        transactions.push({
                            ticker: ticker,
                            sellDate: trade.date,
                            sellPrice: trade.price,
                            quantity: trade.quantity,
                            sellProceeds: sellProceeds,
                            costBasis: costBasis,
                            profitLoss: tradePL,
                            matchedBuys: matchedBuys
                        });
                    }
                });
                
                return transactions;
            };
            
            const totalPL = calculateProfitLoss();
            const [showPLModal, setShowPLModal] = React.useState(false);
            
            // Calculate current positions
            const calculateCurrentPositions = () => {
                const positions = {};
                trades.slice().reverse().forEach(trade => {
                    const ticker = trade.ticker;
                    if (!positions[ticker]) {
                        positions[ticker] = { shares: [], totalShares: 0, avgCost: 0 };
                    }
                    if (trade.transaction_type === 'BUY') {
                        positions[ticker].shares.push({ quantity: trade.quantity, price: trade.price, fees: trade.fees });
                        positions[ticker].totalShares += trade.quantity;
                    } else if (trade.transaction_type === 'SELL') {
                        let remainingToSell = trade.quantity;
                        while (remainingToSell > 0 && positions[ticker].shares.length > 0) {
                            const oldestPurchase = positions[ticker].shares[0];
                            const sellQty = Math.min(remainingToSell, oldestPurchase.quantity);
                            oldestPurchase.quantity -= sellQty;
                            positions[ticker].totalShares -= sellQty;
                            if (oldestPurchase.quantity <= 0) positions[ticker].shares.shift();
                            remainingToSell -= sellQty;
                        }
                    }
                });
                Object.keys(positions).forEach(ticker => {
                    if (positions[ticker].totalShares > 0) {
                        let totalCost = 0;
                        positions[ticker].shares.forEach(purchase => {
                            totalCost += (purchase.quantity * purchase.price) + (purchase.fees || 0);
                        });
                        positions[ticker].avgCost = totalCost / positions[ticker].totalShares;
                    } else {
                        delete positions[ticker];
                    }
                });
                return positions;
            };
            
            const currentPositions = calculateCurrentPositions();
            const [currentPrices, setCurrentPrices] = React.useState({});
            const [showPriceInput, setShowPriceInput] = React.useState(false);
            const [fetchingPrices, setFetchingPrices] = React.useState(false);
            const [lastPriceUpdate, setLastPriceUpdate] = React.useState(null);
            
            // Fetch real-time prices from Yahoo Finance
            const fetchYahooPrices = async () => {
                if (positionCount === 0) return;
                
                setFetchingPrices(true);
                const newPrices = {};
                let successCount = 0;
                let failCount = 0;
                const failedTickers = [];
                
                for (const ticker of Object.keys(currentPositions)) {
                    try {
                        // Add .AX suffix for ASX stocks
                        const yahooTicker = ticker.includes('.') ? ticker : `${ticker}.AX`;
                        
                        console.log(` Fetching price for: ${ticker}  ${yahooTicker}`);
                        
                        // Try direct Yahoo Finance first
                        let url = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooTicker}?interval=1d&range=1d`;
                        let response = await fetch(url);
                        
                        // If CORS error or failed, try with CORS proxy
                        if (!response.ok) {
                            console.log(` Direct fetch failed for ${ticker}, trying CORS proxy...`);
                            url = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooTicker}?interval=1d&range=1d`)}`;
                            response = await fetch(url);
                        }
                        
                        const data = await response.json();
                        
                        console.log(` Response for ${ticker}:`, data);
                        
                        if (data.chart && data.chart.result && data.chart.result[0]) {
                            const result = data.chart.result[0];
                            const currentPrice = result.meta.regularMarketPrice;
                            
                            if (currentPrice && currentPrice > 0) {
                                newPrices[ticker] = currentPrice;
                                successCount++;
                                console.log(` ${ticker}: $${currentPrice}`);
                            } else {
                                failCount++;
                                failedTickers.push(ticker);
                                console.error(` ${ticker}: No valid price in response`);
                            }
                        } else {
                            failCount++;
                            failedTickers.push(ticker);
                            console.error(` ${ticker}: Invalid response structure`);
                        }
                    } catch (error) {
                        console.error(` Failed to fetch price for ${ticker}:`, error.message);
                        failCount++;
                        failedTickers.push(ticker);
                    }
                }
                
                setCurrentPrices(newPrices);
                setLastPriceUpdate(new Date());
                setFetchingPrices(false);
                
                // Show detailed summary
                let message = ` Price Fetch Complete!\n\n`;
                message += ` Success: ${successCount}\n`;
                if (failCount > 0) {
                    message += ` Failed: ${failCount}\n`;
                    message += `\nFailed tickers: ${failedTickers.join(', ')}\n`;
                    message += `\nPossible reasons:\n`;
                    message += ` Ticker not found on Yahoo Finance\n`;
                    message += ` Network/CORS restrictions\n`;
                    message += ` Market closed or data unavailable\n`;
                    message += `\nCheck browser console for details.`;
                }
                
                alert(message);
            };
            
            const calculateUnrealizedPL = () => {
                let unrealizedPL = 0;
                Object.keys(currentPositions).forEach(ticker => {
                    const position = currentPositions[ticker];
                    const currentPrice = currentPrices[ticker] || 0;
                    if (currentPrice > 0) {
                        const marketValue = position.totalShares * currentPrice;
                        const costBasis = position.totalShares * position.avgCost;
                        unrealizedPL += (marketValue - costBasis);
                    }
                });
                return unrealizedPL;
            };
            
            const unrealizedPL = calculateUnrealizedPL();
            const positionCount = Object.keys(currentPositions).length;
            const totalPortfolioValue = Object.keys(currentPositions).reduce((sum, ticker) => {
                const currentPrice = currentPrices[ticker] || 0;
                return sum + (currentPositions[ticker].totalShares * currentPrice);
            }, 0);
            
            return (
                <>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Trades</div>
                            <div className="stat-value">{trades.length}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Open Positions</div>
                            <div className="stat-value">{positionCount}</div>
                        </div>
                        <div className="stat-card" onClick={() => setShowPLModal(true)} style={{cursor: 'pointer', transition: 'transform 0.2s'}} onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.02)'} onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                            <div className="stat-label">Realized P&L </div>
                            <div className={`stat-value ${totalPL >= 0 ? 'positive' : 'negative'}`}>
                                {formatCurrency(totalPL)}
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Unrealized P&L</div>
                            <div className={`stat-value ${unrealizedPL >= 0 ? 'positive' : 'negative'}`}>
                                {formatCurrency(unrealizedPL)}
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Portfolio Value</div>
                            <div className="stat-value positive">
                                {formatCurrency(totalPortfolioValue)}
                            </div>
                        </div>
                    </div>
                    
                    {showPLModal && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center',
                            justifyContent: 'center', zIndex: 1000
                        }} onClick={() => setShowPLModal(false)}>
                            <div style={{
                                background: 'white', padding: '30px', borderRadius: '12px',
                                maxWidth: '900px', maxHeight: '80vh', overflow: 'auto',
                                width: '90%'
                            }} onClick={(e) => e.stopPropagation()}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                    <h2 style={{margin: 0}}> Realized P&L Transactions</h2>
                                    <button onClick={() => setShowPLModal(false)} style={{padding: '8px 16px'}}>Close</button>
                                </div>
                                <div style={{marginBottom: '15px', padding: '15px', background: '#f0f9ff', borderRadius: '8px'}}>
                                    <strong>Total Realized P&L: </strong>
                                    <span className={totalPL >= 0 ? 'positive' : 'negative'} style={{fontSize: '1.2em', fontWeight: 'bold'}}>
                                        {formatCurrency(totalPL)}
                                    </span>
                                </div>
                                {calculateDetailedPL().length === 0 ? (
                                    <p style={{textAlign: 'center', color: '#666', padding: '40px'}}>
                                        No realized gains or losses yet. Sell some shares to see P&L transactions here.
                                    </p>
                                ) : (
                                    calculateDetailedPL().map((transaction, index) => (
                                        <div key={index} style={{
                                            marginBottom: '20px', padding: '20px',
                                            border: '1px solid #ddd', borderRadius: '8px',
                                            background: transaction.profitLoss >= 0 ? '#f0fdf4' : '#fef2f2'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                                <h3 style={{margin: 0}}>{transaction.ticker}</h3>
                                                <div style={{fontSize: '1.2em', fontWeight: 'bold'}}
                                                     className={transaction.profitLoss >= 0 ? 'positive' : 'negative'}>
                                                    {transaction.profitLoss >= 0 ? '+' : ''}{formatCurrency(Math.abs(transaction.profitLoss))}
                                                </div>
                                            </div>
                                            <div style={{marginBottom: '15px'}}>
                                                <strong>SELL:</strong> {transaction.quantity} shares @ ${transaction.sellPrice.toFixed(3)} on {formatDateForDisplay(transaction.sellDate)}
                                                <div style={{marginLeft: '20px', color: '#16a34a'}}>
                                                    Sale Proceeds: {formatCurrency(transaction.sellProceeds)}
                                                </div>
                                            </div>
                                            <div style={{marginBottom: '10px'}}>
                                                <strong>Matched BUY Transactions (FIFO):</strong>
                                            </div>
                                            {transaction.matchedBuys.map((buy, buyIndex) => (
                                                <div key={buyIndex} style={{marginLeft: '20px', marginBottom: '5px', fontSize: '0.9em'}}>
                                                     {buy.quantity} shares @ ${buy.buyPrice.toFixed(3)} purchased on {formatDateForDisplay(buy.buyDate)}
                                                </div>
                                            ))}
                                            <div style={{marginTop: '10px', marginLeft: '20px', color: '#dc2626'}}>
                                                Cost Basis: {formatCurrency(transaction.costBasis)}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}
                    
                    {positionCount > 0 && (
                        <div className="section" style={{marginBottom: '20px'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                <h3 style={{margin: 0}}> Current Positions</h3>
                                <div style={{display: 'flex', gap: '10px'}}>
                                    <button 
                                        onClick={fetchYahooPrices} 
                                        disabled={fetchingPrices}
                                        style={{
                                            fontSize: '0.9rem',
                                            background: fetchingPrices ? '#ccc' : 'var(--success-green)',
                                            cursor: fetchingPrices ? 'wait' : 'pointer'
                                        }}
                                    >
                                        {fetchingPrices ? ' Fetching...' : ' Fetch Live Prices'}
                                    </button>
                                    <button onClick={() => setShowPriceInput(!showPriceInput)} style={{fontSize: '0.9rem'}}>
                                        {showPriceInput ? 'Hide' : 'Manual'} Entry
                                    </button>
                                </div>
                            </div>
                            {lastPriceUpdate && (
                                <div style={{marginBottom: '10px', fontSize: '0.85em', color: '#666'}}>
                                    Last updated: {lastPriceUpdate.toLocaleString('en-AU', {dateStyle: 'short', timeStyle: 'short'})}
                                </div>
                            )}
                            {showPriceInput && (
                                <div style={{marginBottom: '15px', padding: '15px', background: '#f9f9f9', borderRadius: '6px'}}>
                                    <p style={{marginTop: 0, fontSize: '0.9em', color: '#666'}}>
                                         <strong>Manual Entry:</strong> Enter current prices manually if live fetch doesn't work for some tickers.
                                        Enter current prices manually to calculate unrealized P&L.
                                    </p>
                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '10px'}}>
                                        {Object.keys(currentPositions).map(ticker => (
                                            <div key={ticker} style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                                <label style={{fontWeight: '600', minWidth: '60px'}}>{ticker}:</label>
                                                <input 
                                                    type="number" 
                                                    step="0.01" 
                                                    value={currentPrices[ticker] || ''}
                                                    onChange={(e) => setCurrentPrices({...currentPrices, [ticker]: parseFloat(e.target.value) || 0})}
                                                    placeholder="$0.00"
                                                    style={{flex: 1, padding: '6px'}}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Shares</th>
                                        <th>Avg Cost</th>
                                        <th>Current Price</th>
                                        <th>Market Value</th>
                                        <th>Unrealized P&L</th>
                                        <th>Return %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.keys(currentPositions).map(ticker => {
                                        const position = currentPositions[ticker];
                                        const currentPrice = currentPrices[ticker] || 0;
                                        const marketValue = position.totalShares * currentPrice;
                                        const costBasis = position.totalShares * position.avgCost;
                                        const unrealizedPLPosition = marketValue - costBasis;
                                        const returnPercent = costBasis > 0 ? (unrealizedPLPosition / costBasis) * 100 : 0;
                                        
                                        return (
                                            <tr key={ticker}>
                                                <td><strong>{ticker}</strong></td>
                                                <td>{position.totalShares.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                                                <td>${position.avgCost.toFixed(3)}</td>
                                                <td>{currentPrice > 0 ? `$${currentPrice.toFixed(3)}` : '-'}</td>
                                                <td>{currentPrice > 0 ? formatCurrency(marketValue) : '-'}</td>
                                                <td className={unrealizedPLPosition >= 0 ? 'positive' : 'negative'}>
                                                    {currentPrice > 0 ? formatCurrency(unrealizedPLPosition) : '-'}
                                                </td>
                                                <td className={returnPercent >= 0 ? 'positive' : 'negative'}>
                                                    {currentPrice > 0 ? `${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%` : '-'}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Trades</div>
                            <div className="stat-value">{trades.length}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Realized P&L</div>
                            <div className={`stat-value ${totalPL >= 0 ? 'positive' : 'negative'}`}>
                                ${totalPL.toFixed(2)}
                            </div>
                        </div>
                    </div>
                    
                    <div className="section">
                        <h2> Shares Trading</h2>
                        <div className="button-group">
                            <button onClick={() => setShowForm(!showForm)}>
                                {showForm ? 'Cancel' : 'Add Trade Manually'}
                            </button>
                            <label htmlFor="shares-pdf-upload" style={{
                                display: 'inline-block',
                                background: 'var(--success-green)',
                                color: 'white',
                                padding: '12px 24px',
                                borderRadius: '6px',
                                fontFamily: 'Inter, sans-serif',
                                fontSize: '0.95rem',
                                fontWeight: 600,
                                cursor: uploadingPDF ? 'wait' : 'pointer',
                                transition: 'all 0.2s ease',
                                border: 'none',
                                opacity: uploadingPDF ? 0.6 : 1
                            }}>
                                {uploadingPDF ? ' Parsing PDF...' : ' Upload Contract PDF'}
                            </label>
                            <input 
                                id="shares-pdf-upload"
                                type="file" 
                                accept="application/pdf"
                                onChange={handlePDFUpload}
                                style={{display: 'none'}}
                                disabled={uploadingPDF}
                            />
                            <label htmlFor="shares-batch-pdf-upload" style={{
                                display: 'inline-block',
                                background: '#f59e0b',
                                color: 'white',
                                padding: '12px 24px',
                                borderRadius: '6px',
                                fontFamily: 'Inter, sans-serif',
                                fontSize: '0.95rem',
                                fontWeight: 600,
                                cursor: uploadingBatchPDF ? 'wait' : 'pointer',
                                transition: 'all 0.2s ease',
                                border: 'none',
                                opacity: uploadingBatchPDF ? 0.6 : 1
                            }}>
                                {uploadingBatchPDF ? ` Processing ${batchProgress}...` : ' Batch Upload PDFs'}
                            </label>
                            <input 
                                id="shares-batch-pdf-upload"
                                type="file" 
                                accept="application/pdf"
                                multiple
                                onChange={handleBatchPDFUpload}
                                style={{display: 'none'}}
                                disabled={uploadingBatchPDF}
                            />
                        </div>
                        
                        {showForm && (
                            <div className="form-grid" style={{marginTop: '20px'}}>
                                <div className="form-group">
                                    <label>Date</label>
                                    <input 
                                        type="date" 
                                        value={form.date}
                                        onChange={(e) => setForm({...form, date: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Ticker</label>
                                    <input 
                                        type="text" 
                                        value={form.ticker}
                                        onChange={(e) => setForm({...form, ticker: e.target.value})}
                                        placeholder="e.g., BHP, CBA"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Transaction Type</label>
                                    <select 
                                        value={form.transaction_type}
                                        onChange={(e) => setForm({...form, transaction_type: e.target.value})}
                                    >
                                        <option value="BUY">Buy</option>
                                        <option value="SELL">Sell</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Quantity</label>
                                    <input 
                                        type="number" 
                                        step="1"
                                        value={form.quantity}
                                        onChange={(e) => setForm({...form, quantity: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Price per Share ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={form.price}
                                        onChange={(e) => setForm({...form, price: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Brokerage Fees ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={form.fees}
                                        onChange={(e) => setForm({...form, fees: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Notes</label>
                                    <input 
                                        type="text" 
                                        value={form.notes}
                                        onChange={(e) => setForm({...form, notes: e.target.value})}
                                    />
                                </div>
                                <div className="form-group" style={{display: 'flex', alignItems: 'flex-end'}}>
                                    <button onClick={addTrade}>Save Trade</button>
                                </div>
                            </div>
                        )}
                        
                        {trades.length > 0 ? (
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Ticker</th>
                                        <th>Type</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Fees</th>
                                        <th>Total</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {trades.map(trade => (
                                        <tr key={trade.id}>
                                            <td>{formatDateForDisplay(trade.date)}</td>
                                            <td><strong>{trade.ticker}</strong></td>
                                            <td>{trade.transaction_type}</td>
                                            <td>{trade.quantity.toLocaleString()}</td>
                                            <td>${trade.price.toFixed(2)}</td>
                                            <td>${trade.fees.toFixed(2)}</td>
                                            <td className={trade.transaction_type === 'BUY' ? 'negative' : 'positive'}>
                                                ${((trade.quantity * trade.price) + (trade.transaction_type === 'BUY' ? trade.fees : -trade.fees)).toFixed(2)}
                                            </td>
                                            <td>{trade.notes}</td>
                                            <td>
                                                <button className="danger" onClick={() => deleteTrade(trade.id)}>Delete</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div className="empty-state">No trades yet</div>
                        )}
                    </div>
                </>
            );
        };
        
        const OptionsSection = ({ trades, onUpdate }) => {
            const [showForm, setShowForm] = useState(false);
            const [form, setForm] = useState({
                date: '',
                ticker: '',
                option_type: 'CALL',
                strike_price: '',
                expiry_date: '',
                transaction_type: 'BUY',
                contracts: '',
                premium: '',
                fees: '',
                notes: ''
            });
            
            const addTrade = () => {
                db.run(
                    'INSERT INTO options_trades (date, ticker, option_type, strike_price, expiry_date, transaction_type, contracts, premium, fees, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)',
                    [form.date, form.ticker.toUpperCase(), form.option_type, parseFloat(form.strike_price), 
                     form.expiry_date, form.transaction_type, parseInt(form.contracts), parseFloat(form.premium), 
                     parseFloat(form.fees) || 0, form.notes]
                );
                saveDatabase();
                setForm({ date: '', ticker: '', option_type: 'CALL', strike_price: '', expiry_date: '', 
                         transaction_type: 'BUY', contracts: '', premium: '', fees: '', notes: '' });
                setShowForm(false);
                onUpdate();
            };
            
            const deleteTrade = (id) => {
                if (confirm('Delete this options trade?')) {
                    db.run('DELETE FROM options_trades WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const calculateProfitLoss = () => {
                let totalPL = 0;
                trades.forEach(trade => {
                    const contractValue = trade.contracts * trade.premium * 100; // Options contracts are for 100 shares
                    if (trade.transaction_type === 'BUY') {
                        totalPL -= (contractValue + trade.fees);
                    } else {
                        totalPL += (contractValue - trade.fees);
                    }
                });
                return totalPL;
            };
            
            const totalPL = calculateProfitLoss();
            
            return (
                <>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Options Trades</div>
                            <div className="stat-value">{trades.length}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Net P&L</div>
                            <div className={`stat-value ${totalPL >= 0 ? 'positive' : 'negative'}`}>
                                ${totalPL.toFixed(2)}
                            </div>
                        </div>
                    </div>
                    
                    <div className="section">
                        <h2> Options Trading</h2>
                        <button onClick={() => setShowForm(!showForm)}>
                            {showForm ? 'Cancel' : 'Add Options Trade'}
                        </button>
                        
                        {showForm && (
                            <div className="form-grid" style={{marginTop: '20px'}}>
                                <div className="form-group">
                                    <label>Date</label>
                                    <input 
                                        type="date" 
                                        value={form.date}
                                        onChange={(e) => setForm({...form, date: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Ticker</label>
                                    <input 
                                        type="text" 
                                        value={form.ticker}
                                        onChange={(e) => setForm({...form, ticker: e.target.value})}
                                        placeholder="e.g., BHP, CBA"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Option Type</label>
                                    <select 
                                        value={form.option_type}
                                        onChange={(e) => setForm({...form, option_type: e.target.value})}
                                    >
                                        <option value="CALL">Call</option>
                                        <option value="PUT">Put</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Strike Price ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={form.strike_price}
                                        onChange={(e) => setForm({...form, strike_price: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Expiry Date</label>
                                    <input 
                                        type="date" 
                                        value={form.expiry_date}
                                        onChange={(e) => setForm({...form, expiry_date: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Transaction Type</label>
                                    <select 
                                        value={form.transaction_type}
                                        onChange={(e) => setForm({...form, transaction_type: e.target.value})}
                                    >
                                        <option value="BUY">Buy to Open</option>
                                        <option value="SELL">Sell to Close/Write</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Contracts</label>
                                    <input 
                                        type="number" 
                                        step="1"
                                        value={form.contracts}
                                        onChange={(e) => setForm({...form, contracts: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Premium per Contract ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={form.premium}
                                        onChange={(e) => setForm({...form, premium: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Fees ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={form.fees}
                                        onChange={(e) => setForm({...form, fees: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Notes</label>
                                    <input 
                                        type="text" 
                                        value={form.notes}
                                        onChange={(e) => setForm({...form, notes: e.target.value})}
                                    />
                                </div>
                                <div className="form-group" style={{display: 'flex', alignItems: 'flex-end'}}>
                                    <button onClick={addTrade}>Save Options Trade</button>
                                </div>
                            </div>
                        )}
                        
                        {trades.length > 0 ? (
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Ticker</th>
                                        <th>Type</th>
                                        <th>Strike</th>
                                        <th>Expiry</th>
                                        <th>Action</th>
                                        <th>Contracts</th>
                                        <th>Premium</th>
                                        <th>Total</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {trades.map(trade => {
                                        const total = (trade.contracts * trade.premium * 100) + (trade.transaction_type === 'BUY' ? trade.fees : -trade.fees);
                                        return (
                                            <tr key={trade.id}>
                                                <td>{trade.date}</td>
                                                <td><strong>{trade.ticker}</strong></td>
                                                <td>{trade.option_type}</td>
                                                <td>${parseFloat(trade.strike_price).toFixed(2)}</td>
                                                <td>{trade.expiry_date}</td>
                                                <td>
                                                    <span className={trade.transaction_type === 'BUY' ? 'negative' : 'positive'}>
                                                        {trade.transaction_type}
                                                    </span>
                                                </td>
                                                <td>{trade.contracts}</td>
                                                <td>${parseFloat(trade.premium).toFixed(2)}</td>
                                                <td className={trade.transaction_type === 'BUY' ? 'negative' : 'positive'}>
                                                    ${Math.abs(total).toFixed(2)}
                                                </td>
                                                <td>{trade.notes}</td>
                                                <td>
                                                    <div className="action-buttons">
                                                        <button className="danger" onClick={() => deleteTrade(trade.id)}>Delete</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        ) : (
                            <div className="empty-state">No options trades recorded yet</div>
                        )}
                    </div>
                </>
            );
        };
        
        const WagesSection = ({ wages, actualWages, onUpdate }) => {
            const [mode, setMode] = useState('predicted'); // 'predicted' or 'actual'
            const [wageForm, setWageForm] = useState({ pharmacy_name: '', weekly_pretax: '' });
            const [actualForm, setActualForm] = useState({ financial_year: '2025', pharmacy_name: '', actual_pretax: '', actual_tax: '' });
            
            // Australian tax calculation (2024-25 rates)
            const calculateTax = (annualIncome) => {
                if (annualIncome <= 18200) return 0;
                if (annualIncome <= 45000) return (annualIncome - 18200) * 0.19;
                if (annualIncome <= 120000) return 5092 + (annualIncome - 45000) * 0.325;
                if (annualIncome <= 180000) return 29467 + (annualIncome - 120000) * 0.37;
                return 51667 + (annualIncome - 180000) * 0.45;
            };
            
            const addWage = () => {
                console.log('addWage called', wageForm);
                
                if (!wageForm.pharmacy_name || !wageForm.weekly_pretax) {
                    alert('Please fill in pharmacy name and weekly wage');
                    return;
                }
                
                const weeklyPretax = parseFloat(wageForm.weekly_pretax);
                if (isNaN(weeklyPretax) || weeklyPretax <= 0) {
                    alert('Please enter a valid weekly wage amount');
                    return;
                }
                
                try {
                    const annualPretax = weeklyPretax * 52;
                    const annualTax = calculateTax(annualPretax);
                    const weeklyTax = annualTax / 52;
                    const weeklyNet = weeklyPretax - weeklyTax;
                    
                    console.log('Inserting wage:', { pharmacy_name: wageForm.pharmacy_name, weeklyPretax, weeklyTax, weeklyNet });
                    
                    db.run('INSERT INTO wages (pharmacy_name, weekly_pretax, weekly_tax, weekly_net) VALUES (?, ?, ?, ?)',
                        [wageForm.pharmacy_name, weeklyPretax, weeklyTax, weeklyNet]);
                    saveDatabase();
                    setWageForm({ pharmacy_name: '', weekly_pretax: '' });
                    onUpdate();
                    
                    console.log('Wage added successfully');
                } catch (error) {
                    console.error('Error adding wage:', error);
                    alert('Error adding wage: ' + error.message);
                }
            };
            
            const addActual = () => {
                if (!actualForm.pharmacy_name || !actualForm.actual_pretax || !actualForm.actual_tax) {
                    alert('Please fill in all fields');
                    return;
                }
                
                const pretax = parseFloat(actualForm.actual_pretax);
                const tax = parseFloat(actualForm.actual_tax);
                
                if (isNaN(pretax) || pretax <= 0 || isNaN(tax) || tax < 0) {
                    alert('Please enter valid amounts');
                    return;
                }
                
                db.run('INSERT INTO actual_wages (financial_year, pharmacy_name, actual_pretax, actual_tax, actual_net) VALUES (?, ?, ?, ?, ?)',
                    [actualForm.financial_year, actualForm.pharmacy_name, pretax, tax, pretax - tax]);
                saveDatabase();
                setActualForm({ financial_year: '2025', pharmacy_name: '', actual_pretax: '', actual_tax: '' });
                onUpdate();
            };
            
            const deleteWage = (id) => {
                if (confirm('Delete?')) {
                    db.run('DELETE FROM wages WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const deleteActual = (id) => {
                if (confirm('Delete?')) {
                    db.run('DELETE FROM actual_wages WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const totalPredictedAnnual = wages.reduce((sum, w) => sum + (w.weekly_pretax * 52), 0);
            const totalActual = actualWages.reduce((sum, w) => sum + w.actual_pretax, 0);
            const totalActualTax = actualWages.reduce((sum, w) => sum + w.actual_tax, 0);
            
            return (
                <div className="section">
                    <h2> Part-Time Wages</h2>
                    
                    <nav className="nav-tabs" style={{marginTop: '20px'}}>
                        <button className={`nav-tab ${mode === 'predicted' ? 'active' : ''}`} onClick={() => setMode('predicted')}>Predicted (Weekly)</button>
                        <button className={`nav-tab ${mode === 'actual' ? 'active' : ''}`} onClick={() => setMode('actual')}>Actual (End of Year)</button>
                    </nav>
                    
                    {mode === 'predicted' && (
                        <>
                            <div className="stats-grid" style={{marginTop: '20px'}}>
                                <div className="stat-card">
                                    <div className="stat-label">Predicted Annual Income</div>
                                    <div className="stat-value positive">{formatCurrency(totalPredictedAnnual)}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-label">Predicted Annual Tax</div>
                                    <div className="stat-value negative">{formatCurrency(calculateTax(totalPredictedAnnual))}</div>
                                </div>
                            </div>
                            
                            <div className="form-card" style={{marginTop: '20px'}}>
                                <h3>Add Weekly Wage</h3>
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label>Pharmacy Name</label>
                                        <input 
                                            list="pharmacy-names-predicted"
                                            value={wageForm.pharmacy_name} 
                                            onChange={(e) => setWageForm({...wageForm, pharmacy_name: e.target.value})} 
                                            placeholder="Select or type pharmacy name"
                                        />
                                        <datalist id="pharmacy-names-predicted">
                                            {(() => {
                                                const uniquePharmacies = new Set();
                                                wages.forEach(w => uniquePharmacies.add(w.pharmacy_name));
                                                actualWages.forEach(w => uniquePharmacies.add(w.pharmacy_name));
                                                return Array.from(uniquePharmacies).sort().map((name, idx) => (
                                                    <option key={idx} value={name} />
                                                ));
                                            })()}
                                        </datalist>
                                    </div>
                                    <div className="form-group">
                                        <label>Weekly Pre-Tax ($)</label>
                                        <input type="number" step="0.01" value={wageForm.weekly_pretax} onChange={(e) => setWageForm({...wageForm, weekly_pretax: e.target.value})} />
                                    </div>
                                    <div className="form-group">
                                        <button onClick={addWage}>Add</button>
                                    </div>
                                </div>
                            </div>
                            
                            <table className="data-table" style={{marginTop: '20px'}}>
                                <thead>
                                    <tr><th>Pharmacy</th><th>Weekly Pre-Tax</th><th>Weekly Tax</th><th>Weekly Net</th><th>Annual Pre-Tax</th><th>Actions</th></tr>
                                </thead>
                                <tbody>
                                    {wages.map(w => (
                                        <tr key={w.id}>
                                            <td>{w.pharmacy_name}</td>
                                            <td>{formatCurrency(w.weekly_pretax)}</td>
                                            <td className="negative">{formatCurrency(w.weekly_tax)}</td>
                                            <td>{formatCurrency(w.weekly_net)}</td>
                                            <td className="positive">{formatCurrency(w.weekly_pretax * 52)}</td>
                                            <td><button onClick={() => deleteWage(w.id)} style={{background: '#d9534f', padding: '5px 10px'}}>Delete</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </>
                    )}
                    
                    {mode === 'actual' && (
                        <>
                            <div className="stats-grid" style={{marginTop: '20px'}}>
                                <div className="stat-card">
                                    <div className="stat-label">Total Actual Income</div>
                                    <div className="stat-value positive">{formatCurrency(totalActual)}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-label">Total Actual Tax Paid</div>
                                    <div className="stat-value negative">{formatCurrency(totalActualTax)}</div>
                                </div>
                            </div>
                            
                            <div className="form-card" style={{marginTop: '20px'}}>
                                <h3>Add Actual Wages (End of Year)</h3>
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label>Financial Year</label>
                                        <select value={actualForm.financial_year} onChange={(e) => setActualForm({...actualForm, financial_year: e.target.value})}>
                                            <option value="2025">FY 2025-2026</option>
                                            <option value="2024">FY 2024-2025</option>
                                            <option value="2023">FY 2023-2024</option>
                                            <option value="2022">FY 2022-2023</option>
                                            <option value="2021">FY 2021-2022</option>
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>Pharmacy Name</label>
                                        <input 
                                            list="pharmacy-names-actual"
                                            value={actualForm.pharmacy_name} 
                                            onChange={(e) => setActualForm({...actualForm, pharmacy_name: e.target.value})}
                                            placeholder="Select or type pharmacy name"
                                        />
                                        <datalist id="pharmacy-names-actual">
                                            {(() => {
                                                const uniquePharmacies = new Set();
                                                wages.forEach(w => uniquePharmacies.add(w.pharmacy_name));
                                                actualWages.forEach(w => uniquePharmacies.add(w.pharmacy_name));
                                                return Array.from(uniquePharmacies).sort().map((name, idx) => (
                                                    <option key={idx} value={name} />
                                                ));
                                            })()}
                                        </datalist>
                                    </div>
                                    <div className="form-group">
                                        <label>Actual Pre-Tax ($)</label>
                                        <input type="number" step="0.01" value={actualForm.actual_pretax} onChange={(e) => setActualForm({...actualForm, actual_pretax: e.target.value})} />
                                    </div>
                                    <div className="form-group">
                                        <label>Actual Tax Paid ($)</label>
                                        <input type="number" step="0.01" value={actualForm.actual_tax} onChange={(e) => setActualForm({...actualForm, actual_tax: e.target.value})} />
                                    </div>
                                    <div className="form-group">
                                        <button onClick={addActual}>Add</button>
                                    </div>
                                </div>
                            </div>
                            
                            <table className="data-table" style={{marginTop: '20px'}}>
                                <thead>
                                    <tr><th>FY</th><th>Pharmacy</th><th>Pre-Tax</th><th>Tax Paid</th><th>Net</th><th>Actions</th></tr>
                                </thead>
                                <tbody>
                                    {actualWages.map(w => (
                                        <tr key={w.id}>
                                            <td>FY {w.financial_year}/{(parseInt(w.financial_year) + 1).toString().slice(-2)}</td>
                                            <td>{w.pharmacy_name}</td>
                                            <td className="positive">{formatCurrency(w.actual_pretax)}</td>
                                            <td className="negative">{formatCurrency(w.actual_tax)}</td>
                                            <td>{formatCurrency(w.actual_net)}</td>
                                            <td><button onClick={() => deleteActual(w.id)} style={{background: '#d9534f', padding: '5px 10px'}}>Delete</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </>
                    )}
                </div>
            );
        };
        
        const SuperannuationSection = ({ wages, actualWages, invoices, selfSuperContributions, onUpdate }) => {
            const [selectedFY, setSelectedFY] = useState('2025');
            const [form, setForm] = useState({
                date: new Date().toISOString().split('T')[0],
                amount: '',
                description: ''
            });
            const [editingSGRate, setEditingSGRate] = useState(null);
            const [sgRateForm, setSGRateForm] = useState({ financial_year: '', sg_rate: '', concessional_cap: '' });
            
            // Get SG rate and cap for selected financial year from database
            let SUPER_GUARANTEE_RATE = 0.115; // Default fallback
            let CONCESSIONAL_CAP = 30000; // Default fallback
            
            try {
                const sgRateResult = db.exec("SELECT sg_rate, concessional_cap FROM super_guarantee_rates WHERE financial_year = ?", [selectedFY]);
                if (sgRateResult.length > 0 && sgRateResult[0].values.length > 0) {
                    SUPER_GUARANTEE_RATE = sgRateResult[0].values[0][0];
                    CONCESSIONAL_CAP = sgRateResult[0].values[0][1];
                }
            } catch (error) {
                console.error('Error loading SG rate:', error);
            }
            
            // Calculate compulsory employer contributions from wages (using correct historical rate)
            const wageSuper = wages.reduce((sum, w) => {
                const annualWage = w.weekly_pretax * 52;
                return sum + (annualWage * SUPER_GUARANTEE_RATE);
            }, 0);
            
            // Calculate super from locum invoices (already included in invoice amounts)
            const locumSuper = invoices
                .filter(inv => {
                    const date = new Date(inv.invoice_date);
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const fy = month >= 6 ? year : year - 1;
                    return fy.toString() === selectedFY;
                })
                .reduce((sum, inv) => sum + inv.super_amount, 0);
            
            // Calculate self contributions for selected FY
            const selfContribs = selfSuperContributions
                .filter(c => c.financial_year === selectedFY)
                .reduce((sum, c) => sum + c.amount, 0);
            
            const totalCompulsory = wageSuper + locumSuper;
            const totalConcessional = totalCompulsory + selfContribs;
            const remainingCap = CONCESSIONAL_CAP - totalConcessional;
            
            const addContribution = () => {
                if (!form.amount || parseFloat(form.amount) <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }
                
                try {
                    db.run('INSERT INTO self_super_contributions (financial_year, date, amount, description) VALUES (?, ?, ?, ?)',
                        [selectedFY, form.date, parseFloat(form.amount), form.description]);
                    saveDatabase();
                    setForm({ date: new Date().toISOString().split('T')[0], amount: '', description: '' });
                    onUpdate();
                } catch (error) {
                    console.error('Error adding super contribution:', error);
                    alert('Error: ' + error.message);
                }
            };
            
            const deleteContribution = (id) => {
                if (confirm('Delete this contribution?')) {
                    db.run('DELETE FROM self_super_contributions WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const startEditSGRate = (fy, rate, cap) => {
                setEditingSGRate(fy);
                setSGRateForm({
                    financial_year: fy,
                    sg_rate: (rate * 100).toFixed(1),
                    concessional_cap: cap.toString()
                });
            };
            
            const cancelEditSGRate = () => {
                setEditingSGRate(null);
                setSGRateForm({ financial_year: '', sg_rate: '', concessional_cap: '' });
            };
            
            const saveSGRate = () => {
                if (!sgRateForm.sg_rate || !sgRateForm.concessional_cap) {
                    alert('Please fill in all fields');
                    return;
                }
                
                const rate = parseFloat(sgRateForm.sg_rate) / 100;
                const cap = parseFloat(sgRateForm.concessional_cap);
                
                if (isNaN(rate) || rate < 0 || rate > 1 || isNaN(cap) || cap <= 0) {
                    alert('Please enter valid values (SG rate 0-100%, cap > 0)');
                    return;
                }
                
                try {
                    if (editingSGRate) {
                        // Update existing
                        db.run('UPDATE super_guarantee_rates SET sg_rate = ?, concessional_cap = ? WHERE financial_year = ?',
                            [rate, cap, editingSGRate]);
                    } else {
                        // Insert new
                        db.run('INSERT OR REPLACE INTO super_guarantee_rates (financial_year, sg_rate, concessional_cap) VALUES (?, ?, ?)',
                            [sgRateForm.financial_year, rate, cap]);
                    }
                    saveDatabase();
                    cancelEditSGRate();
                    onUpdate();
                } catch (error) {
                    console.error('Error saving SG rate:', error);
                    alert('Error: ' + error.message);
                }
            };
            
            const addNewSGRate = () => {
                setEditingSGRate('new');
                setSGRateForm({ financial_year: '', sg_rate: '11.5', concessional_cap: '30000' });
            };
            
            return (
                <div className="section">
                    <h2> Superannuation</h2>
                    <p style={{color: 'var(--text-secondary)', marginBottom: '20px'}}>
                        Track compulsory employer contributions and manage your voluntary (self) super contributions for tax deductions.
                    </p>
                    
                    <div className="form-group" style={{maxWidth: '250px', marginBottom: '30px'}}>
                        <label>Financial Year</label>
                        <select value={selectedFY} onChange={(e) => setSelectedFY(e.target.value)}>
                            <option value="2025">FY 2025-2026</option>
                            <option value="2024">FY 2024-2025</option>
                            <option value="2023">FY 2023-2024</option>
                            <option value="2022">FY 2022-2023</option>
                            <option value="2021">FY 2021-2022</option>
                        </select>
                    </div>
                    
                    <div className="stats-grid" style={{marginBottom: '30px'}}>
                        <div className="stat-card" style={{background: 'rgba(59, 130, 246, 0.1)', borderLeft: '4px solid #3b82f6'}}>
                            <div className="stat-label">Compulsory Employer Super</div>
                            <div className="stat-value" style={{color: '#3b82f6', fontSize: '1.8rem'}}>{formatCurrency(totalCompulsory)}</div>
                            <p style={{fontSize: '0.85em', color: 'var(--text-secondary)', marginTop: '8px'}}>
                                Wages: {formatCurrency(wageSuper)} + Locum: {formatCurrency(locumSuper)}
                            </p>
                        </div>
                        <div className="stat-card" style={{background: 'rgba(16, 185, 129, 0.1)', borderLeft: '4px solid #10b981'}}>
                            <div className="stat-label">Your Self Contributions</div>
                            <div className="stat-value" style={{color: '#10b981', fontSize: '1.8rem'}}>{formatCurrency(selfContribs)}</div>
                            <p style={{fontSize: '0.85em', color: 'var(--text-secondary)', marginTop: '8px'}}>
                                Tax deductible voluntary contributions
                            </p>
                        </div>
                        <div className="stat-card" style={{background: 'rgba(245, 158, 11, 0.1)', borderLeft: '4px solid #f59e0b'}}>
                            <div className="stat-label">Total Concessional</div>
                            <div className="stat-value" style={{color: '#f59e0b', fontSize: '1.8rem'}}>{formatCurrency(totalConcessional)}</div>
                            <p style={{fontSize: '0.85em', color: 'var(--text-secondary)', marginTop: '8px'}}>
                                Cap: {formatCurrency(CONCESSIONAL_CAP)} ({SUPER_GUARANTEE_RATE * 100}% SG rate)
                            </p>
                        </div>
                    </div>
                    
                    <div style={{padding: '20px', background: remainingCap > 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)', borderRadius: '8px', marginBottom: '30px', border: `2px solid ${remainingCap > 0 ? '#10b981' : '#ef4444'}`}}>
                        <h3 style={{color: remainingCap > 0 ? '#10b981' : '#ef4444', marginBottom: '10px'}}>
                            {remainingCap > 0 ? ' Contribution Room Available' : ' Concessional Cap Reached'}
                        </h3>
                        <p style={{fontSize: '1.3rem', fontWeight: 'bold', color: remainingCap > 0 ? '#10b981' : '#ef4444'}}>
                            {remainingCap > 0 ? `You can contribute ${formatCurrency(remainingCap)} more` : 'Cap exceeded - additional contributions taxed at 47%'}
                        </p>
                        <p style={{fontSize: '0.9em', color: 'var(--text-secondary)', marginTop: '10px'}}>
                            FY {selectedFY}/{(parseInt(selectedFY) + 1).toString().slice(-2)} concessional cap: {formatCurrency(CONCESSIONAL_CAP)} 
                            {remainingCap > 0 && ' (including employer contributions)'}
                        </p>
                    </div>
                    
                    <div className="form-card" style={{marginBottom: '30px'}}>
                        <h3> Add Self Contribution (Tax Deductible)</h3>
                        <div className="form-grid">
                            <div className="form-group">
                                <label>Date</label>
                                <input type="date" value={form.date} onChange={(e) => setForm({...form, date: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Amount ($)</label>
                                <input type="number" step="0.01" value={form.amount} onChange={(e) => setForm({...form, amount: e.target.value})} placeholder="5000.00" />
                            </div>
                            <div className="form-group" style={{gridColumn: '1 / -1'}}>
                                <label>Description</label>
                                <input type="text" value={form.description} onChange={(e) => setForm({...form, description: e.target.value})} placeholder="E.g., Quarterly voluntary contribution" />
                            </div>
                            <div className="form-group">
                                <button onClick={addContribution}>Add Contribution</button>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style={{marginBottom: '15px'}}>Self Contributions History (FY {selectedFY}/{(parseInt(selectedFY) + 1).toString().slice(-2)})</h3>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {selfSuperContributions.filter(c => c.financial_year === selectedFY).length === 0 ? (
                                <tr>
                                    <td colSpan="4" className="empty-state">No self contributions recorded for this financial year</td>
                                </tr>
                            ) : (
                                selfSuperContributions
                                    .filter(c => c.financial_year === selectedFY)
                                    .map(contrib => (
                                        <tr key={contrib.id}>
                                            <td>{formatDateForDisplay(contrib.date)}</td>
                                            <td>{contrib.description}</td>
                                            <td className="positive">{formatCurrency(contrib.amount)}</td>
                                            <td>
                                                <button onClick={() => deleteContribution(contrib.id)} style={{background: '#d9534f', padding: '5px 10px'}}>
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                            )}
                        </tbody>
                    </table>
                    
                    <div style={{marginTop: '30px', padding: '15px', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '8px'}}>
                        <h4 style={{color: '#3b82f6', marginBottom: '10px'}}> Key Information for FY {selectedFY}/{(parseInt(selectedFY) + 1).toString().slice(-2)}</h4>
                        <ul style={{lineHeight: '1.8', color: 'var(--text-secondary)', paddingLeft: '20px', fontSize: '0.9em'}}>
                            <li>Super Guarantee rate: <strong>{(SUPER_GUARANTEE_RATE * 100).toFixed(1)}%</strong></li>
                            <li>Concessional contributions cap: <strong>{formatCurrency(CONCESSIONAL_CAP)}</strong> per financial year</li>
                            <li>Self contributions are tax deductible (claim via Notice of Intent to your super fund)</li>
                            <li>Contributions above cap are taxed at <strong>47%</strong> (excess contributions tax)</li>
                            <li>Compulsory employer super is automatically calculated using the correct historical SG rate</li>
                            <li>Locum super is tracked from your invoices</li>
                        </ul>
                        
                        <details style={{marginTop: '15px'}}>
                            <summary style={{cursor: 'pointer', color: '#3b82f6', fontWeight: '500'}}> View/Edit Historical SG Rates</summary>
                            
                            <div style={{marginTop: '15px', marginBottom: '10px'}}>
                                <button onClick={addNewSGRate} style={{background: '#10b981', padding: '8px 16px', fontSize: '0.9em'}}>
                                     Add New Year
                                </button>
                            </div>
                            
                            {editingSGRate === 'new' && (
                                <div className="form-card" style={{marginBottom: '15px'}}>
                                    <h4>Add New Financial Year SG Rate</h4>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Financial Year</label>
                                            <input 
                                                type="text" 
                                                value={sgRateForm.financial_year} 
                                                onChange={(e) => setSGRateForm({...sgRateForm, financial_year: e.target.value})}
                                                placeholder="2026"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>SG Rate (%)</label>
                                            <input 
                                                type="number" 
                                                step="0.1" 
                                                value={sgRateForm.sg_rate} 
                                                onChange={(e) => setSGRateForm({...sgRateForm, sg_rate: e.target.value})}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Concessional Cap ($)</label>
                                            <input 
                                                type="number" 
                                                step="100" 
                                                value={sgRateForm.concessional_cap} 
                                                onChange={(e) => setSGRateForm({...sgRateForm, concessional_cap: e.target.value})}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <button onClick={saveSGRate} style={{background: '#10b981'}}>Save</button>
                                            <button onClick={cancelEditSGRate} style={{background: '#6b7280', marginLeft: '10px'}}>Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <table style={{width: '100%', marginTop: '10px', fontSize: '0.85em'}} className="data-table">
                                <thead>
                                    <tr>
                                        <th>Financial Year</th>
                                        <th>SG Rate</th>
                                        <th>Concessional Cap</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        try {
                                            const rates = db.exec("SELECT financial_year, sg_rate, concessional_cap FROM super_guarantee_rates ORDER BY financial_year DESC");
                                            if (rates.length > 0) {
                                                return rates[0].values.map((row, idx) => {
                                                    const fy = row[0];
                                                    const rate = row[1];
                                                    const cap = row[2];
                                                    
                                                    if (editingSGRate === fy) {
                                                        return (
                                                            <tr key={idx} style={{background: 'rgba(59, 130, 246, 0.1)'}}>
                                                                <td>FY {fy}/{(parseInt(fy) + 1).toString().slice(-2)}</td>
                                                                <td>
                                                                    <input 
                                                                        type="number" 
                                                                        step="0.1" 
                                                                        value={sgRateForm.sg_rate}
                                                                        onChange={(e) => setSGRateForm({...sgRateForm, sg_rate: e.target.value})}
                                                                        style={{width: '80px', padding: '4px'}}
                                                                    /> %
                                                                </td>
                                                                <td>
                                                                    $ <input 
                                                                        type="number" 
                                                                        step="100" 
                                                                        value={sgRateForm.concessional_cap}
                                                                        onChange={(e) => setSGRateForm({...sgRateForm, concessional_cap: e.target.value})}
                                                                        style={{width: '100px', padding: '4px'}}
                                                                    />
                                                                </td>
                                                                <td>
                                                                    <button onClick={saveSGRate} style={{background: '#10b981', padding: '4px 8px', marginRight: '5px'}}>
                                                                        Save
                                                                    </button>
                                                                    <button onClick={cancelEditSGRate} style={{background: '#6b7280', padding: '4px 8px'}}>
                                                                        Cancel
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    }
                                                    
                                                    return (
                                                        <tr key={idx}>
                                                            <td>FY {fy}/{(parseInt(fy) + 1).toString().slice(-2)}</td>
                                                            <td>{(rate * 100).toFixed(1)}%</td>
                                                            <td>{formatCurrency(cap)}</td>
                                                            <td>
                                                                <button 
                                                                    onClick={() => startEditSGRate(fy, rate, cap)} 
                                                                    style={{background: '#3b82f6', padding: '4px 8px'}}
                                                                >
                                                                    Edit
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                });
                                            }
                                            return <tr><td colSpan="4">No data</td></tr>;
                                        } catch (e) {
                                            return <tr><td colSpan="4">Error loading rates</td></tr>;
                                        }
                                    })()}
                                </tbody>
                            </table>
                        </details>
                    </div>
                </div>
            );
        };
        
        const ProfessionalExpensesSection = ({ expenses, onUpdate }) => {
            const [showForm, setShowForm] = useState(false);
            const [form, setForm] = useState({
                date: new Date().toISOString().split('T')[0],
                category: 'Registration',
                amount: '',
                description: '',
                deductible: true
            });
            
            const addExpense = () => {
                if (!form.amount || parseFloat(form.amount) <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }
                
                db.run(
                    'INSERT INTO locum_expenses (date, category, amount, description, deductible) VALUES (?, ?, ?, ?, ?)',
                    [form.date, form.category, parseFloat(form.amount), form.description, form.deductible ? 1 : 0]
                );
                saveDatabase();
                setForm({
                    date: new Date().toISOString().split('T')[0],
                    category: 'Registration',
                    amount: '',
                    description: '',
                    deductible: true
                });
                setShowForm(false);
                onUpdate();
            };
            
            const deleteExpense = (id) => {
                if (confirm('Delete this expense?')) {
                    db.run('DELETE FROM locum_expenses WHERE id = ?', [id]);
                    saveDatabase();
                    onUpdate();
                }
            };
            
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const deductibleTotal = expenses.filter(e => e.deductible).reduce((sum, exp) => sum + exp.amount, 0);
            
            return (
                <div className="section">
                    <h2> Professional Expenses</h2>
                    <p style={{color: 'var(--text-secondary)', marginBottom: '20px'}}>
                        Track your professional expenses as a pharmacist (registration, insurance, CPD, etc.)
                    </p>
                    
                    <div className="stats-grid" style={{marginBottom: '30px'}}>
                        <div className="stat-card">
                            <div className="stat-label">Total Expenses</div>
                            <div className="stat-value negative">{formatCurrency(totalExpenses)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Tax Deductible</div>
                            <div className="stat-value negative">{formatCurrency(deductibleTotal)}</div>
                        </div>
                    </div>
                    
                    <button onClick={() => setShowForm(!showForm)} style={{marginBottom: '20px'}}>
                        {showForm ? 'Cancel' : '+ Add Expense'}
                    </button>
                    
                    {showForm && (
                        <div className="form-card" style={{marginBottom: '30px'}}>
                            <h3>Add Professional Expense</h3>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>Date</label>
                                    <input 
                                        type="date" 
                                        value={form.date}
                                        onChange={(e) => setForm({...form, date: e.target.value})}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Category</label>
                                    <select 
                                        value={form.category}
                                        onChange={(e) => setForm({...form, category: e.target.value})}
                                    >
                                        <option>Registration (AHPRA)</option>
                                        <option>Insurance (Professional Indemnity)</option>
                                        <option>Subscription</option>
                                        <option>CPD/Training</option>
                                        <option>Equipment</option>
                                        <option>Uniform</option>
                                        <option>Travel</option>
                                        <option>Accommodation</option>
                                        <option>Phone/Internet</option>
                                        <option>Accounting/Tax</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Amount ($)</label>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={form.amount}
                                        onChange={(e) => setForm({...form, amount: e.target.value})}
                                        placeholder="0.00"
                                    />
                                </div>
                                <div className="form-group" style={{gridColumn: '1 / -1'}}>
                                    <label>Description</label>
                                    <input 
                                        type="text" 
                                        value={form.description}
                                        onChange={(e) => setForm({...form, description: e.target.value})}
                                        placeholder="E.g., Annual AHPRA registration renewal"
                                    />
                                </div>
                                <div className="form-group">
                                    <label style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <input 
                                            type="checkbox" 
                                            checked={form.deductible}
                                            onChange={(e) => setForm({...form, deductible: e.target.checked})}
                                        />
                                        Tax Deductible
                                    </label>
                                </div>
                                <div className="form-group">
                                    <button onClick={addExpense}>Add Expense</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Deductible</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {expenses.length === 0 ? (
                                <tr>
                                    <td colSpan="6" className="empty-state">No expenses recorded yet</td>
                                </tr>
                            ) : (
                                expenses.map(expense => (
                                    <tr key={expense.id}>
                                        <td>{formatDateForDisplay(expense.date)}</td>
                                        <td>{expense.category}</td>
                                        <td>{expense.description}</td>
                                        <td className="negative">{formatCurrency(expense.amount)}</td>
                                        <td>{expense.deductible ? ' Yes' : ' No'}</td>
                                        <td>
                                            <button 
                                                onClick={() => deleteExpense(expense.id)}
                                                style={{background: '#d9534f', padding: '5px 10px', fontSize: '0.9em'}}
                                            >
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            );
        };
        
        const TaxReportSection = ({ properties, rentalIncome, rentalExpenses, sharesTrades, optionsTrades, invoices, personalDetails, professionalExpenses, wages, actualWages, selfSuperContributions }) => {
            const [selectedFinancialYear, setSelectedFinancialYear] = useState('');
            const [breakdownModal, setBreakdownModal] = useState({ show: false, title: '', data: [] });
            
            try {
                // Safety checks - ensure all data exists
                const safeRentalIncome = rentalIncome || [];
                const safeRentalExpenses = rentalExpenses || [];
                const safeSharesTrades = sharesTrades || [];
                const safeOptionsTrades = optionsTrades || [];
                const safeInvoices = invoices || [];
                const safeProfessionalExpenses = professionalExpenses || [];
                const safeWages = wages || [];
                const safeActualWages = actualWages || [];
                
                // Generate list of financial years from available data
                const getAvailableFinancialYears = () => {
                    const years = new Set();
                    
                    // Get years from all data sources
                    [...safeRentalIncome, ...safeRentalExpenses, ...safeSharesTrades, ...safeOptionsTrades].forEach(item => {
                        if (item.date) {
                            const date = new Date(item.date);
                            const year = date.getFullYear();
                            const month = date.getMonth(); // 0-11
                        
                        // Financial year is July to June
                        // If month is Jul-Dec (6-11), financial year is current year
                        // If month is Jan-Jun (0-5), financial year is previous year
                        const financialYear = month >= 6 ? year : year - 1;
                        years.add(financialYear);
                    }
                });
                
                return Array.from(years).sort((a, b) => b - a);
            };
            
            const availableYears = getAvailableFinancialYears();
            
            // Set default to current financial year if not set
            React.useEffect(() => {
                if (!selectedFinancialYear && availableYears.length > 0) {
                    // Default to most recent financial year
                    setSelectedFinancialYear(availableYears[0].toString());
                }
            }, [availableYears.length]);
            
            // Filter data by financial year
            const filterByFinancialYear = (items) => {
                if (!selectedFinancialYear) return items;
                
                const fyStart = new Date(`${selectedFinancialYear}-07-01`);
                const fyEnd = new Date(`${parseInt(selectedFinancialYear) + 1}-06-30`);
                
                return items.filter(item => {
                    if (!item.date) return false;
                    const itemDate = new Date(item.date);
                    return itemDate >= fyStart && itemDate <= fyEnd;
                });
            };
            
            // Filter data for selected financial year
            const filteredRentalIncome = filterByFinancialYear(safeRentalIncome);
            const filteredRentalExpenses = filterByFinancialYear(safeRentalExpenses);
            const filteredSharesTrades = filterByFinancialYear(safeSharesTrades);
            const filteredOptionsTrades = filterByFinancialYear(safeOptionsTrades);
            const filteredInvoices = safeInvoices.length > 0 
                ? filterByFinancialYear(safeInvoices.map(inv => ({...inv, date: inv.invoice_date})))
                : [];
            
            // Calculate rental income totals from filtered data
            const totalRentalIncome = filteredRentalIncome.reduce((sum, item) => sum + item.amount, 0);
            const deductibleExpenses = filteredRentalExpenses.filter(e => e.deductible).reduce((sum, item) => sum + item.amount, 0);
            const netRentalIncome = totalRentalIncome - deductibleExpenses;
            
            // Calculate pharmacist income (locum + wages) and professional expenses
            const totalLocumIncome = filteredInvoices.reduce((sum, inv) => sum + inv.total_amount + inv.super_amount, 0);
            
            // Calculate wage income (use actual if available for selected year, otherwise predicted)
            const filteredActualWages = safeActualWages.filter(w => w.financial_year === selectedFinancialYear);
            const totalWageIncome = filteredActualWages.length > 0 
                ? filteredActualWages.reduce((sum, w) => sum + w.actual_pretax, 0)
                : safeWages.reduce((sum, w) => sum + (w.weekly_pretax * 52), 0);
            
            // Total pharmacist income before expenses
            const totalPharmacistIncome = totalLocumIncome + totalWageIncome;
            
            // Apply professional expenses to total pharmacist income
            const filteredProfessionalExpenses = filterByFinancialYear(safeProfessionalExpenses);
            const deductibleProfessionalExpenses = filteredProfessionalExpenses.filter(e => e.deductible).reduce((sum, exp) => sum + exp.amount, 0);
            const netPharmacistIncome = totalPharmacistIncome - deductibleProfessionalExpenses;
            
            // Calculate shares capital gains using FIFO with filtered data
            const calculateSharesGains = () => {
                const positions = {};
                let totalGains = 0;
                
                filteredSharesTrades.slice().reverse().forEach(trade => {
                    const ticker = trade.ticker;
                    if (!positions[ticker]) {
                        positions[ticker] = { shares: [] };
                    }
                    
                    if (trade.transaction_type === 'BUY') {
                        positions[ticker].shares.push({
                            quantity: trade.quantity,
                            price: trade.price,
                            fees: trade.fees
                        });
                    } else if (trade.transaction_type === 'SELL') {
                        let remainingToSell = trade.quantity;
                        let sellProceeds = (trade.quantity * trade.price) - trade.fees;
                        let costBasis = 0;
                        
                        while (remainingToSell > 0 && positions[ticker].shares.length > 0) {
                            const oldestPurchase = positions[ticker].shares[0];
                            const sellQty = Math.min(remainingToSell, oldestPurchase.quantity);
                            
                            costBasis += (sellQty * oldestPurchase.price) + (oldestPurchase.fees * sellQty / oldestPurchase.quantity);
                            
                            oldestPurchase.quantity -= sellQty;
                            if (oldestPurchase.quantity <= 0) {
                                positions[ticker].shares.shift();
                            }
                            
                            remainingToSell -= sellQty;
                        }
                        
                        totalGains += (sellProceeds - costBasis);
                    }
                });
                
                return totalGains;
            };
            
            const sharesCapitalGains = calculateSharesGains();
            
            // Calculate options P&L from filtered data
            const optionsPL = filteredOptionsTrades.reduce((total, trade) => {
                const contractValue = trade.contracts * trade.premium * 100;
                if (trade.transaction_type === 'BUY') {
                    return total - (contractValue + trade.fees);
                } else {
                    return total + (contractValue - trade.fees);
                }
            }, 0);
            
            const totalTaxableIncome = netRentalIncome + netPharmacistIncome + sharesCapitalGains + optionsPL;
            
            // Self super contributions (tax deductible) - need safeSelfSuperContributions
            const safeSelfSuperContributions = selfSuperContributions || [];
            const filteredSelfSuper = safeSelfSuperContributions.filter(c => c.financial_year === selectedFinancialYear);
            const totalSelfSuperDeduction = filteredSelfSuper.reduce((sum, c) => sum + c.amount, 0);
            
            // Final taxable income after super deduction
            const finalTaxableIncome = totalTaxableIncome - totalSelfSuperDeduction;
            
            // Calculate predicted tax based on Australian tax rates (2024-25)
            const calculatePredictedTax = (annualIncome) => {
                if (annualIncome <= 18200) return 0;
                if (annualIncome <= 45000) return (annualIncome - 18200) * 0.19;
                if (annualIncome <= 120000) return 5092 + (annualIncome - 45000) * 0.325;
                if (annualIncome <= 180000) return 29467 + (annualIncome - 120000) * 0.37;
                return 51667 + (annualIncome - 180000) * 0.45;
            };
            
            const predictedTax = calculatePredictedTax(finalTaxableIncome);
            const netIncomeAfterTax = finalTaxableIncome - predictedTax;
            
            // Functions to show detailed breakdowns
            const showWagesBreakdown = () => {
                const data = [];
                if (filteredActualWages.length > 0) {
                    filteredActualWages.forEach(w => {
                        data.push({
                            label: `${w.pharmacy_name} (FY ${w.financial_year}/${(parseInt(w.financial_year) + 1).toString().slice(-2)})`,
                            amount: w.actual_pretax
                        });
                    });
                } else {
                    wages.forEach(w => {
                        data.push({
                            label: `${w.pharmacy_name} (Weekly: ${formatCurrency(w.weekly_pretax)})`,
                            amount: w.weekly_pretax * 52
                        });
                    });
                }
                setBreakdownModal({
                    show: true,
                    title: filteredActualWages.length > 0 ? 'Actual Part-Time Wages Breakdown' : 'Predicted Part-Time Wages Breakdown',
                    data: data,
                    total: totalWageIncome
                });
            };
            
            const showLocumBreakdown = () => {
                const data = filteredInvoices.map(inv => ({
                    label: `${inv.pharmacy_name} - Invoice #${inv.invoice_number} (${formatDateForDisplay(inv.invoice_date)})`,
                    amount: inv.total_amount + inv.super_amount
                }));
                setBreakdownModal({
                    show: true,
                    title: 'Locum Income Breakdown',
                    data: data,
                    total: totalLocumIncome
                });
            };
            
            const showProfessionalExpensesBreakdown = () => {
                const data = filteredProfessionalExpenses.filter(e => e.deductible).map(exp => ({
                    label: `${exp.category} - ${exp.description || 'No description'} (${formatDateForDisplay(exp.date)})`,
                    amount: exp.amount
                }));
                setBreakdownModal({
                    show: true,
                    title: 'Professional Expenses Breakdown (Deductible)',
                    data: data,
                    total: deductibleProfessionalExpenses
                });
            };
            
            const showRentalIncomeBreakdown = () => {
                const data = filteredRentalIncome.map(inc => ({
                    label: `${inc.property_name} - ${inc.description || 'Rent'} (${formatDateForDisplay(inc.date)})`,
                    amount: inc.amount
                }));
                setBreakdownModal({
                    show: true,
                    title: 'Rental Income Breakdown',
                    data: data,
                    total: totalRentalIncome
                });
            };
            
            const showRentalExpensesBreakdown = () => {
                const data = filteredRentalExpenses.filter(e => e.deductible).map(exp => ({
                    label: `${exp.property_name} - ${exp.category} (${formatDateForDisplay(exp.date)})`,
                    amount: exp.amount
                }));
                setBreakdownModal({
                    show: true,
                    title: 'Rental Expenses Breakdown (Deductible)',
                    data: data,
                    total: totalRentalExpenses
                });
            };
            
            const showSelfSuperBreakdown = () => {
                const data = filteredSelfSuper.map(c => ({
                    label: `${c.description || 'Self contribution'} (${formatDateForDisplay(c.date)})`,
                    amount: c.amount
                }));
                setBreakdownModal({
                    show: true,
                    title: 'Self Super Contributions Breakdown',
                    data: data,
                    total: totalSelfSuperDeduction
                });
            };
            
            const exportToJSON = () => {
                const taxData = {
                    applicationName: 'Tan Pham - Incomes and expenses',
                    financialYear: `FY ${selectedFinancialYear}/${(parseInt(selectedFinancialYear) + 1).toString().slice(-2)}`,
                    period: `1 July ${selectedFinancialYear} - 30 June ${parseInt(selectedFinancialYear) + 1}`,
                    generatedDate: new Date().toISOString(),
                    rentalProperties: {
                        properties: properties,
                        totalIncome: totalRentalIncome,
                        deductibleExpenses: deductibleExpenses,
                        netIncome: netRentalIncome,
                        incomeRecords: filteredRentalIncome,
                        expenseRecords: filteredRentalExpenses
                    },
                    sharesTrading: {
                        totalTrades: filteredSharesTrades.length,
                        capitalGains: sharesCapitalGains,
                        trades: filteredSharesTrades
                    },
                    optionsTrading: {
                        totalTrades: filteredOptionsTrades.length,
                        netProfitLoss: optionsPL,
                        trades: filteredOptionsTrades
                    },
                    summary: {
                        totalTaxableIncome: totalTaxableIncome,
                        rentalIncome: netRentalIncome,
                        investmentIncome: sharesCapitalGains + optionsPL
                    }
                };
                
                const dataStr = JSON.stringify(taxData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `tax-report-FY${selectedFinancialYear}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            };
            
            const exportToCSV = () => {
                let csv = `Tan Pham - Incomes and expenses\n`;
                csv += `Financial Year: FY ${selectedFinancialYear}/${(parseInt(selectedFinancialYear) + 1).toString().slice(-2)}\n`;
                csv += `Period: 1 July ${selectedFinancialYear} - 30 June ${parseInt(selectedFinancialYear) + 1}\n`;
                csv += `Generated: ${new Date().toLocaleDateString()}\n\n`;
                
                csv += 'RENTAL PROPERTIES\n';
                csv += 'Property Name,Address,Monthly Rent,Contract Start,Contract End,Tenant\n';
                properties.forEach(p => {
                    csv += `"${p.property_name}","${p.address}","${p.monthly_rent}","${p.contract_start}","${p.contract_end}","${p.tenant_name}"\n`;
                });
                
                csv += '\nRENTAL INCOME\n';
                csv += 'Property,Date,Amount,Description\n';
                filteredRentalIncome.forEach(i => {
                    csv += `"${i.property_name}","${i.date}","${i.amount}","${i.description}"\n`;
                });
                
                csv += '\nRENTAL EXPENSES\n';
                csv += 'Property,Date,Category,Amount,Description,Deductible\n';
                filteredRentalExpenses.forEach(e => {
                    csv += `"${e.property_name}","${e.date}","${e.category}","${e.amount}","${e.description}","${e.deductible ? 'Yes' : 'No'}"\n`;
                });
                
                csv += '\nSHARES TRADING\n';
                csv += 'Date,Ticker,Type,Quantity,Price,Fees,Notes\n';
                filteredSharesTrades.forEach(t => {
                    csv += `"${t.date}","${t.ticker}","${t.transaction_type}","${t.quantity}","${t.price}","${t.fees}","${t.notes}"\n`;
                });
                
                csv += '\nOPTIONS TRADING\n';
                csv += 'Date,Ticker,Option Type,Strike,Expiry,Transaction,Contracts,Premium,Fees,Notes\n';
                filteredOptionsTrades.forEach(t => {
                    csv += `"${t.date}","${t.ticker}","${t.option_type}","${t.strike_price}","${t.expiry_date}","${t.transaction_type}","${t.contracts}","${t.premium}","${t.fees}","${t.notes}"\n`;
                });
                
                csv += '\nSUMMARY\n';
                csv += `Total Rental Income,$${totalRentalIncome.toFixed(2)}\n`;
                csv += `Deductible Expenses,$${deductibleExpenses.toFixed(2)}\n`;
                csv += `Net Rental Income,$${netRentalIncome.toFixed(2)}\n`;
                csv += `Shares Capital Gains,$${sharesCapitalGains.toFixed(2)}\n`;
                csv += `Options P&L,$${optionsPL.toFixed(2)}\n`;
                csv += `Total Taxable Income,$${totalTaxableIncome.toFixed(2)}\n`;
                
                const dataBlob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `tax-report-FY${selectedFinancialYear}-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };
            
            const exportToPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 20;
                
                // Header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Australian Tax Report', 105, y, { align: 'center' });
                y += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Financial Year ${selectedFinancialYear}/${(parseInt(selectedFinancialYear) + 1).toString().slice(-2)}`, 105, y, { align: 'center' });
                y += 5;
                doc.setFontSize(10);
                doc.text(`Period: 1 July ${selectedFinancialYear} - 30 June ${parseInt(selectedFinancialYear) + 1}`, 105, y, { align: 'center' });
                y += 15;
                
                // Personal Details
                if (personalDetails && personalDetails.full_name) {
                    doc.setFontSize(10);
                    doc.text(`Name: ${personalDetails.full_name}`, 20, y);
                    y += 6;
                    if (personalDetails.tfn) {
                        doc.text(`TFN: ${personalDetails.tfn}`, 20, y);
                        y += 6;
                    }
                    if (personalDetails.abn) {
                        doc.text(`ABN: ${personalDetails.abn}`, 20, y);
                        y += 6;
                    }
                    y += 5;
                }
                
                // Line separator
                doc.setLineWidth(0.5);
                doc.line(20, y, 190, y);
                y += 10;
                
                // Rental Property Income
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Rental Property Income', 20, y);
                y += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Total Rental Income:`, 25, y);
                doc.text(`${formatCurrency(totalRentalIncome)}`, 150, y, { align: 'right' });
                y += 6;
                doc.text(`Less: Deductible Expenses:`, 25, y);
                doc.text(`-${formatCurrency(deductibleExpenses)}`, 150, y, { align: 'right' });
                y += 6;
                doc.setFont(undefined, 'bold');
                doc.text(`Net Rental Income:`, 25, y);
                doc.text(`${formatCurrency(netRentalIncome)}`, 150, y, { align: 'right' });
                y += 10;
                
                // Pharmacist Income (Locum + Wages)
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Pharmacist Income', 20, y);
                y += 8;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Locum Work (incl. Super):`, 25, y);
                doc.text(`${formatCurrency(totalLocumIncome)}`, 150, y, { align: 'right' });
                y += 6;
                const wageLabel = filteredActualWages.length > 0 ? 'Part-Time Wages (Actual):' : 'Part-Time Wages (Predicted):';
                doc.text(wageLabel, 25, y);
                doc.text(`${formatCurrency(totalWageIncome)}`, 150, y, { align: 'right' });
                y += 6;
                doc.setFont(undefined, 'bold');
                doc.text(`Total Pharmacist Income:`, 25, y);
                doc.text(`${formatCurrency(totalPharmacistIncome)}`, 150, y, { align: 'right' });
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text(`Less: Professional Expenses:`, 25, y);
                doc.text(`-${formatCurrency(deductibleProfessionalExpenses)}`, 150, y, { align: 'right' });
                y += 6;
                doc.setFont(undefined, 'bold');
                doc.text(`Net Pharmacist Income:`, 25, y);
                doc.text(`${formatCurrency(netPharmacistIncome)}`, 150, y, { align: 'right' });
                y += 10;
                
                // Investment Income
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Investment Income', 20, y);
                y += 8;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Shares Capital Gains (FIFO):`, 25, y);
                doc.text(`${formatCurrency(sharesCapitalGains)}`, 150, y, { align: 'right' });
                y += 6;
                doc.text(`Options Trading P&L:`, 25, y);
                doc.text(`${formatCurrency(optionsPL)}`, 150, y, { align: 'right' });
                y += 6;
                doc.setFont(undefined, 'bold');
                doc.text(`Total Investment Income:`, 25, y);
                doc.text(`${formatCurrency(sharesCapitalGains + optionsPL)}`, 150, y, { align: 'right' });
                y += 15;
                
                // Total
                doc.setFillColor(240, 240, 240);
                doc.rect(20, y - 8, 170, 12, 'F');
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('TOTAL TAXABLE INCOME:', 25, y);
                doc.text(`${formatCurrency(totalTaxableIncome)}`, 150, y, { align: 'right' });
                y += 10;
                
                // Predicted Tax
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Predicted Tax Liability', 20, y);
                y += 8;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Estimated Tax (2024-25 rates):', 25, y);
                doc.text(`-${formatCurrency(predictedTax)}`, 150, y, { align: 'right' });
                y += 6;
                doc.setFont(undefined, 'bold');
                doc.text('Net Income After Tax:', 25, y);
                doc.text(`${formatCurrency(netIncomeAfterTax)}`, 150, y, { align: 'right' });
                y += 4;
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.text(' Estimate only. Actual tax may vary. Consult accountant.', 25, y);
                y += 10;
                
                // Notes
                doc.setFontSize(12);
                doc.text('Notes for Accountant', 20, y);
                y += 8;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const notes = [
                    ' Rental expenses marked as deductible are included in calculations',
                    ' Shares capital gains calculated using FIFO (First In First Out) method',
                    ' All brokerage fees included in cost basis calculations',
                    ' Options contracts valued at standard 100 shares per contract',
                    ' Keep all supporting documentation for ATO verification'
                ];
                notes.forEach(note => {
                    doc.text(note, 25, y);
                    y += 5;
                });
                
                // Save
                doc.save(`tax-report-FY${selectedFinancialYear}-${new Date().toISOString().split('T')[0]}.pdf`);
            };
            
            return (
                <div className="section">
                    <h2> Australian Tax Report</h2>
                    
                    <div className="form-grid" style={{maxWidth: '400px', marginBottom: '30px'}}>
                        <div className="form-group">
                            <label>Financial Year</label>
                            <select 
                                value={selectedFinancialYear}
                                onChange={(e) => setSelectedFinancialYear(e.target.value)}
                            >
                                <option value="">Select Financial Year</option>
                                {availableYears.map(year => (
                                    <option key={year} value={year}>
                                        FY {year}/{(year + 1).toString().slice(-2)} (1 July {year} - 30 June {year + 1})
                                    </option>
                                ))}
                            </select>
                        </div>
                    </div>
                    
                    {!selectedFinancialYear ? (
                        <div className="empty-state">Please select a financial year to view tax report</div>
                    ) : (
                        <>
                    
                    <div className="tax-report">
                        <h3>Financial Year {selectedFinancialYear}/{(parseInt(selectedFinancialYear) + 1).toString().slice(-2)} Summary</h3>
                        <p style={{color: 'var(--text-secondary)', marginBottom: '20px'}}>
                            Period: 1 July {selectedFinancialYear} - 30 June {parseInt(selectedFinancialYear) + 1}
                        </p>
                        
                        <div className="tax-section">
                            <h4 style={{color: 'var(--rust-orange)', marginBottom: '15px'}}>Rental Property Income</h4>
                            <div className="tax-line">
                                <span>Total Rental Income:</span>
                                <span 
                                    className="positive"
                                    style={{cursor: 'pointer', textDecoration: 'underline'}}
                                    onClick={showRentalIncomeBreakdown}
                                    title="Click to see breakdown"
                                >
                                    {formatCurrency(totalRentalIncome)}
                                </span>
                            </div>
                            <div className="tax-line">
                                <span>Less: Deductible Expenses:</span>
                                <span 
                                    className="negative"
                                    style={{cursor: 'pointer', textDecoration: 'underline'}}
                                    onClick={showRentalExpensesBreakdown}
                                    title="Click to see breakdown"
                                >
                                    -{formatCurrency(deductibleExpenses)}
                                </span>
                            </div>
                            <div className="tax-line total">
                                <span>Net Rental Income:</span>
                                <span className={netRentalIncome >= 0 ? 'positive' : 'negative'}>
                                    {formatCurrency(netRentalIncome)}
                                </span>
                            </div>
                        </div>
                        
                        <div className="tax-section">
                            <h4 style={{color: 'var(--rust-orange)', marginBottom: '15px'}}> Pharmacist Income</h4>
                            <div className="tax-line">
                                <span>Locum Work (incl. Super):</span>
                                <span 
                                    className="positive" 
                                    style={{cursor: 'pointer', textDecoration: 'underline'}}
                                    onClick={showLocumBreakdown}
                                    title="Click to see breakdown"
                                >
                                    {formatCurrency(totalLocumIncome)}
                                </span>
                            </div>
                            <div className="tax-line">
                                <span>{filteredActualWages.length > 0 ? 'Part-Time Wages (Actual):' : 'Part-Time Wages (Predicted):'}</span>
                                <span 
                                    className="positive"
                                    style={{cursor: 'pointer', textDecoration: 'underline'}}
                                    onClick={showWagesBreakdown}
                                    title="Click to see breakdown"
                                >
                                    {formatCurrency(totalWageIncome)}
                                </span>
                            </div>
                            {filteredActualWages.length === 0 && safeWages.length > 0 && (
                                <p style={{fontSize: '0.8em', color: 'var(--text-secondary)', marginTop: '4px', marginLeft: '20px', fontStyle: 'italic'}}>
                                     Using predicted wages
                                </p>
                            )}
                            <div className="tax-line" style={{borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: '8px', marginTop: '8px'}}>
                                <span>Total Pharmacist Income:</span>
                                <span className="positive">{formatCurrency(totalPharmacistIncome)}</span>
                            </div>
                            <div className="tax-line">
                                <span>Less: Professional Expenses:</span>
                                <span 
                                    className="negative"
                                    style={{cursor: 'pointer', textDecoration: 'underline'}}
                                    onClick={showProfessionalExpensesBreakdown}
                                    title="Click to see breakdown"
                                >
                                    -{formatCurrency(deductibleProfessionalExpenses)}
                                </span>
                            </div>
                            <div className="tax-line total">
                                <span>Net Pharmacist Income:</span>
                                <span className={netPharmacistIncome >= 0 ? 'positive' : 'negative'}>{formatCurrency(netPharmacistIncome)}</span>
                            </div>
                        </div>
                        
                        <div className="tax-section">
                            <h4 style={{color: 'var(--rust-orange)', marginBottom: '15px'}}>Investment Income</h4>
                            <div className="tax-line">
                                <span>Shares Capital Gains (FIFO):</span>
                                <span className={sharesCapitalGains >= 0 ? 'positive' : 'negative'}>
                                    {formatCurrency(sharesCapitalGains)}
                                </span>
                            </div>
                            <div className="tax-line">
                                <span>Options Trading P&L:</span>
                                <span className={optionsPL >= 0 ? 'positive' : 'negative'}>
                                    {formatCurrency(optionsPL)}
                                </span>
                            </div>
                            <div className="tax-line total">
                                <span>Total Investment Income:</span>
                                <span className={(sharesCapitalGains + optionsPL) >= 0 ? 'positive' : 'negative'}>
                                    {formatCurrency(sharesCapitalGains + optionsPL)}
                                </span>
                            </div>
                        </div>
                        
                        <div className="tax-section" style={{borderLeft: '4px solid var(--gold-accent)'}}>
                            <div className="tax-line total" style={{fontSize: '1.5rem'}}>
                                <span>TOTAL TAXABLE INCOME:</span>
                                <span className={totalTaxableIncome >= 0 ? 'positive' : 'negative'}>
                                    {formatCurrency(totalTaxableIncome)}
                                </span>
                            </div>
                            {totalSelfSuperDeduction > 0 && (
                                <>
                                    <div className="tax-line" style={{marginTop: '10px', fontSize: '1.1rem'}}>
                                        <span>Less: Self Super Contributions (Tax Deductible):</span>
                                        <span 
                                            className="negative"
                                            style={{cursor: 'pointer', textDecoration: 'underline'}}
                                            onClick={showSelfSuperBreakdown}
                                            title="Click to see breakdown"
                                        >
                                            -{formatCurrency(totalSelfSuperDeduction)}
                                        </span>
                                    </div>
                                    <div className="tax-line total" style={{fontSize: '1.3rem', marginTop: '8px', borderTop: '2px solid rgba(218, 165, 32, 0.3)', paddingTop: '10px'}}>
                                        <span>FINAL TAXABLE INCOME:</span>
                                        <span className={finalTaxableIncome >= 0 ? 'positive' : 'negative'}>
                                            {formatCurrency(finalTaxableIncome)}
                                        </span>
                                    </div>
                                </>
                            )}
                        </div>
                        
                        <div className="tax-section" style={{background: 'rgba(239, 68, 68, 0.1)', borderLeft: '4px solid #ef4444', marginTop: '20px'}}>
                            <h4 style={{color: '#ef4444', marginBottom: '15px'}}> Predicted Tax Liability</h4>
                            <div className="tax-line">
                                <span>Estimated Tax (2024-25 rates):</span>
                                <span className="negative" style={{fontSize: '1.2rem', fontWeight: 'bold'}}>
                                    -{formatCurrency(predictedTax)}
                                </span>
                            </div>
                            <div className="tax-line total" style={{marginTop: '10px', borderTop: '2px solid rgba(239, 68, 68, 0.3)', paddingTop: '10px'}}>
                                <span>Net Income After Tax:</span>
                                <span className="positive" style={{fontSize: '1.2rem', fontWeight: 'bold'}}>
                                    {formatCurrency(netIncomeAfterTax)}
                                </span>
                            </div>
                            <p style={{fontSize: '0.85em', color: 'var(--text-secondary)', marginTop: '12px', fontStyle: 'italic'}}>
                                 This is an estimate only. Actual tax may vary based on deductions, offsets, and other factors. Consult your accountant.
                            </p>
                        </div>
                        
                        <div style={{marginTop: '30px', padding: '20px', background: 'rgba(218, 165, 32, 0.1)', borderRadius: '8px'}}>
                            <h4 style={{color: 'var(--gold-accent)', marginBottom: '10px'}}> Notes for Accountant</h4>
                            <ul style={{lineHeight: '1.8', color: 'var(--text-secondary)', paddingLeft: '20px'}}>
                                <li>Rental expenses marked as deductible are included in calculations</li>
                                <li>Shares capital gains calculated using FIFO (First In First Out) method</li>
                                <li>All brokerage fees included in cost basis calculations</li>
                                <li>Options contracts valued at standard 100 shares per contract</li>
                                <li>Keep all supporting documentation for ATO verification</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div className="export-buttons">
                        <button onClick={exportToPDF} style={{background: 'var(--primary-color)'}}>
                             Export to PDF
                        </button>
                        <button onClick={exportToJSON} className="secondary">
                             Export to JSON
                        </button>
                        <button onClick={exportToCSV} className="secondary">
                             Export to CSV
                        </button>
                    </div>
                    
                    {/* Breakdown Modal */}
                    {breakdownModal.show && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 1000
                        }} onClick={() => setBreakdownModal({ show: false, title: '', data: [] })}>
                            <div style={{
                                background: 'white',
                                color: '#1a1a1a',
                                borderRadius: '12px',
                                padding: '30px',
                                maxWidth: '800px',
                                maxHeight: '80vh',
                                overflow: 'auto',
                                boxShadow: '0 10px 40px rgba(0,0,0,0.3)'
                            }} onClick={(e) => e.stopPropagation()}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                    <h3 style={{color: '#d97706', margin: 0}}>{breakdownModal.title}</h3>
                                    <button 
                                        onClick={() => setBreakdownModal({ show: false, title: '', data: [] })}
                                        style={{
                                            background: '#6b7280',
                                            border: 'none',
                                            borderRadius: '50%',
                                            width: '32px',
                                            height: '32px',
                                            cursor: 'pointer',
                                            fontSize: '1.2rem',
                                            color: 'white'
                                        }}
                                    >
                                        
                                    </button>
                                </div>
                                
                                <table className="data-table" style={{marginBottom: '20px', borderColor: '#d1d5db'}}>
                                    <thead>
                                        <tr style={{background: '#f3f4f6'}}>
                                            <th style={{textAlign: 'left', color: '#1a1a1a', borderColor: '#d1d5db'}}>Description</th>
                                            <th style={{textAlign: 'right', color: '#1a1a1a', borderColor: '#d1d5db'}}>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {breakdownModal.data.map((item, idx) => (
                                            <tr key={idx} style={{borderColor: '#e5e7eb'}}>
                                                <td style={{color: '#374151', borderColor: '#e5e7eb'}}>{item.label}</td>
                                                <td style={{textAlign: 'right', color: '#059669', fontWeight: '600', borderColor: '#e5e7eb'}}>
                                                    {formatCurrency(item.amount)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr style={{borderTop: '2px solid #d97706', fontWeight: 'bold', background: '#fef3c7'}}>
                                            <td style={{color: '#1a1a1a', borderColor: '#d97706'}}>TOTAL</td>
                                            <td style={{textAlign: 'right', color: '#059669', fontWeight: 'bold', fontSize: '1.1rem', borderColor: '#d97706'}}>
                                                {formatCurrency(breakdownModal.total)}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                                
                                <button 
                                    onClick={() => setBreakdownModal({ show: false, title: '', data: [] })}
                                    style={{width: '100%', background: 'var(--primary-color)'}}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    )}
                    </>
                    )}
                </div>
            );
            } catch (error) {
                console.error('Tax Report Error:', error);
                return (
                    <div className="section">
                        <h2> Tax Report</h2>
                        <div style={{padding: '40px', textAlign: 'center', color: '#d9534f'}}>
                            <p>Error loading tax report: {error.message}</p>
                            <p style={{fontSize: '0.9em', marginTop: '10px'}}>Please check the browser console for details.</p>
                        </div>
                    </div>
                );
            }
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>